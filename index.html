<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HYPE Dashboard</title>
  <meta name="color-scheme" content="dark" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    body{background:#0a0a0a;color:#fff}
    .card{border:1px solid rgba(255,255,255,.12);border-radius:1rem;background:rgba(255,255,255,.03)}
  </style>
</head>
<body class="bg-black text-white">
  <main class="p-6 max-w-6xl mx-auto grid gap-6">
    <h1 class="text-3xl font-bold">HYPE Dashboard</h1>

    <!-- Address input for "Your Staked" -->
    <div class="flex items-center gap-2">
      <input id="addr" placeholder="Paste your Hyperliquid address (0x...)" class="w-full max-w-md bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm" />
      <button id="addrSave" class="rounded-lg border border-white/15 px-3 py-2 text-sm">Save</button>
    </div>

    <!-- KPI Cards -->
    <section id="stats" class="grid gap-4 md:grid-cols-4">
      <div class="card p-4">
        <div class="text-xs opacity-70">Price</div>
        <div class="text-2xl font-semibold" id="price">—</div>
        <div class="text-xs opacity-60" id="price-change">24h: —</div>
      </div>
      <div class="card p-4">
        <div class="text-xs opacity-70">24h Volume</div>
        <div class="text-2xl font-semibold" id="volume">—</div>
      </div>
      <div class="card p-4">
        <div class="text-xs opacity-70">Your Staked</div>
        <div class="text-2xl font-semibold" id="staked">—</div>
      </div>
      <div class="card p-4">
        <div class="text-xs opacity-70">Your Staked Value</div>
        <div class="text-2xl font-semibold" id="staked-value">—</div>
      </div>
    </section>

    <!-- Price Chart -->
    <section class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Price (Mini)</h2>
        <div class="text-xs opacity-70">Live 1m candles</div>
      </div>
      <canvas id="priceChart" height="120"></canvas>
    </section>

    <!-- Debug messages -->
    <div id="debug" class="text-xs text-rose-300 hidden"></div>
  </main>

  <script>
    // ======= CONFIG (through your Vercel proxies) =======
    const HL_INFO = '/api/hl';                 // POST -> Hyperliquid info
    const HL_WS   = 'wss://api.hyperliquid.xyz/ws';
    let   HYPE_SPOT = '@107';                  // will auto-detect from spotMeta
    const CG_ID  = 'hyperliquid';              // correct CoinGecko slug

    // ======= State =======
    let CG_PRICE = 0;      // USD price from CoinGecko
    let STAKED_HYPE = 0;   // HYPE delegated (from delegatorSummary)

    // ======= Helpers =======
    const $ = (id) => document.getElementById(id);
    const fmtM = (n) => `$${(Number(n||0)/1_000_000).toFixed(2)}M`;
    const fmtUsd = (n) => {
      const v = Number(n||0);
      if (v >= 1_000_000) return `$${(v/1_000_000).toFixed(2)}M`;
      if (v >= 1_000)     return `$${(v/1_000).toFixed(2)}k`;
      return `$${v.toFixed(v < 1 ? 4 : 2)}`;
    };
    function showErr(label, err){
      const d=$('debug'); d.classList.remove('hidden');
      const line=document.createElement('div'); line.textContent=`[${label}] ${err}`;
      d.appendChild(line);
      console.error(`[${label}]`, err);
    }

    // ======= Simple HL POST wrapper =======
    async function postHL(body){
      const r = await fetch(HL_INFO, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok) throw new Error(`HL ${r.status}`);
      return r.json();
    }

    // ======= KPIs: CoinGecko =======
    async function fetchCG(){
      try{
        const r = await fetch(`/api/cg?id=${encodeURIComponent(CG_ID)}`);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const arr = await r.json();
        if(!Array.isArray(arr) || arr.length===0) throw new Error('empty response');
        return arr[0];
      }catch(e){ showErr('CoinGecko', e.message || e); return null; }
    }
    async function loadKPIs(){
      const cg = await fetchCG();
      if(cg){
        CG_PRICE = Number(cg.current_price||0);
        $('price').textContent = fmtUsd(CG_PRICE);
        const chg = Number(cg.price_change_percentage_24h||0);
        $('price-change').textContent = `24h: ${chg>=0?'+':''}${chg.toFixed(2)}%`;
        $('volume').textContent = fmtM(cg.total_volume||0);
        // After price updates, recompute staked value if we already know HYPE amount
        if (STAKED_HYPE > 0) $('staked-value').textContent = fmtUsd(STAKED_HYPE * CG_PRICE);
      }
    }

    // ======= Auto-detect HYPE spot index (for WS) =======
    async function detectHypeId(){
      try{
        const meta = await postHL({ type:'spotMeta' });
        const uni  = meta?.universe || meta?.spotMeta?.universe || [];
        const found = uni.find(u => String(u?.name||u?.token||'').toUpperCase().includes('HYPE'));
        if(found?.index) HYPE_SPOT = found.index; // e.g. "@107"
      }catch(e){ showErr('spotMeta', e.message || e); } // non-fatal
    }

    // ======= Your Staked (per address) + USD value =======
    async function loadYourStaked(addr){
      if(!addr){ $('staked').textContent = '—'; $('staked-value').textContent = '—'; return; }
      try{
        const s = await postHL({ type:'delegatorSummary', user: addr });
        const amt = Number(s?.delegated || 0);
        STAKED_HYPE = amt;
        $('staked').textContent = amt > 0 ? `${amt.toFixed(2)} HYPE` : '—';
        $('staked-value').textContent = (amt > 0 && CG_PRICE > 0) ? fmtUsd(amt * CG_PRICE) : (amt > 0 ? '—' : '—');
      }catch(e){
        $('staked').textContent = '—';
        $('staked-value').textContent = '—';
        showErr('delegatorSummary', e.message || e);
      }
    }
    (function setupAddr(){
      const saved = localStorage.getItem('hl_addr')||'';
      if(saved) $('addr').value = saved, loadYourStaked(saved);
      $('addrSave').onclick = () => {
        const a = ($('addr').value||'').trim();
        localStorage.setItem('hl_addr', a);
        loadYourStaked(a);
      };
    })();

    // ======= Chart: seed with snapshot, then keep live via WS =======
    let chart;
    function renderChart(series){
      const ctx = $('priceChart');
      const data = { labels: series.map(p=>p.t), datasets:[{ label:'Price', data: series.map(p=>p.v) }] };
      if(chart) chart.destroy();
      chart = new Chart(ctx, { type:'line', data });
    }
    async function seedChart(){
      try{
        const now = Date.now();
        const start = now - 24*60*60*1000;
        const snap = await postHL({ type:'candleSnapshot', req:{ coin:HYPE_SPOT, interval:'1m', startTime:start, endTime:now } });
        if(Array.isArray(snap) && snap.length){
          const series = snap.slice(-120).map(c=>({
            t: new Date(c.t).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
            v: Number(c.c)
          }));
          renderChart(series);
        }
      }catch(e){ showErr('seedChart', e.message || e); }
    }
    function connectWS(){
      try{
        const ws = new WebSocket(HL_WS);
        ws.onopen = () => {
          ws.send(JSON.stringify({ method:'subscribe', subscription:{ type:'candle', coin:HYPE_SPOT, interval:'1m' }}));
        };
        ws.onmessage = (ev) => {
          try{
            const m = JSON.parse(ev.data||'{}');
            if(m.channel==='candle' && Array.isArray(m.data)){
              const series = m.data.slice(-120).map(c=>({
                t: new Date(c.t).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
                v: Number(c.c)
              }));
              renderChart(series);
            }
          }catch(e){ showErr('ws message', e.message || e); }
        };
        ws.onerror = () => showErr('ws', 'connection error');
        ws.onclose  = () => setTimeout(connectWS, 3000);
      }catch(e){ showErr('ws init', e.message || e); }
    }

    // ======= Boot =======
    (async () => {
      await detectHypeId();     // set correct WS coin id if available
      await loadKPIs();         // price / 24h / volume (sets CG_PRICE)
      await seedChart();        // fill chart immediately
      // load staked AFTER price so value can compute immediately if address is present
      const saved = localStorage.getItem('hl_addr')||'';
      if(saved) await loadYourStaked(saved);
      connectWS();              // keep chart live
    })();
  </script>
</body>
</html>
