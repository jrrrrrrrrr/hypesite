<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HYPE Dashboard</title>
  <meta name="color-scheme" content="dark" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    body{background:#0a0a0a;color:#fff}
    .card{border:1px solid rgba(255,255,255,.12);border-radius:1rem;background:rgba(255,255,255,.03)}
  </style>
</head>
<body class="bg-black text-white">
  <main class="p-6 max-w-6xl mx-auto grid gap-6">
    <h1 class="text-3xl font-bold">HYPE Dashboard</h1>

    <!-- Optional: address input to show "Your Staked" -->
    <div class="flex items-center gap-2">
      <input id="addr" placeholder="Paste your Hyperliquid address (0x...)" class="w-full max-w-md bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm" />
      <button id="addrSave" class="rounded-lg border border-white/15 px-3 py-2 text-sm">Save</button>
    </div>

    <!-- KPI Cards -->
    <section id="stats" class="grid gap-4 md:grid-cols-4">
      <div class="card p-4">
        <div class="text-xs opacity-70">Price</div>
        <div class="text-2xl font-semibold" id="price">—</div>
        <div class="text-xs opacity-60" id="price-change">24h: —</div>
      </div>
      <div class="card p-4">
        <div class="text-xs opacity-70">24h Volume</div>
        <div class="text-2xl font-semibold" id="volume">—</div>
      </div>
      <div class="card p-4">
        <div class="text-xs opacity-70">Your Staked</div>
        <div class="text-2xl font-semibold" id="staked">—</div>
      </div>
      <div class="card p-4">
        <div class="text-xs opacity-70">Builders Rev (24h)</div>
        <div class="text-2xl font-semibold" id="builders-rev">—</div>
      </div>
    </section>

    <!-- Price Chart -->
    <section class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Price (Mini)</h2>
        <div class="text-xs opacity-70">Live 1m candles</div>
      </div>
      <canvas id="priceChart" height="120"></canvas>
    </section>

    <!-- Simple debug area (hidden unless there are errors) -->
    <div id="debug" class="text-xs text-rose-300 hidden"></div>
  </main>

  <script>
    // ========= CONFIG (via your Vercel proxies) =========
    const HL_INFO = '/api/hl';                 // POST -> Hyperliquid info
    const HL_WS   = 'wss://api.hyperliquid.xyz/ws';
    let   HYPE_SPOT = '@107';                  // will auto-detect from spotMeta
    const CG_ID  = 'hyperliquid';              // confirmed CoinGecko slug

    // ========= Helpers =========
    const $ = (id) => document.getElementById(id);
    const fmtM = (n) => `$${(Number(n||0)/1_000_000).toFixed(2)}M`;
    function showErr(label, err){
      const d = $('debug');
      d.classList.remove('hidden');
      const line = document.createElement('div');
      line.textContent = `[${label}] ${err}`;
      d.appendChild(line);
      console.error(`[${label}]`, err);
    }

    // ========= KPIs: CoinGecko =========
    async function fetchCG(){
      try{
        const r = await fetch(`/api/cg?id=${encodeURIComponent(CG_ID)}`);
        if(!r.ok){ throw new Error(`HTTP ${r.status}`); }
        const arr = await r.json();
        if(!Array.isArray(arr) || arr.length===0){ throw new Error('empty response'); }
        return arr[0];
      }catch(e){ showErr('CoinGecko', e.message || e); return null; }
    }
    async function loadKPIs(){
      const cg = await fetchCG();
      if(cg){
        const px = Number(cg.current_price||0);
        $('price').textContent = `$${px.toFixed(px<1?4:2)}`;
        const chg = Number(cg.price_change_percentage_24h||0);
        $('price-change').textContent = `24h: ${chg>=0?'+':''}${chg.toFixed(2)}%`;
        $('volume').textContent = fmtM(cg.total_volume||0);
      }
    }

    // ========= Auto-detect HYPE spot index (for WS) =========
    async function detectHypeId(){
      try{
        const r = await fetch(HL_INFO, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ type:'spotMeta' })
        });
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const meta = await r.json();
        const uni = meta?.universe || meta?.spotMeta?.universe || [];
        const found = uni.find(u => String(u?.name||u?.token||'').toUpperCase().includes('HYPE'));
        if(found?.index) HYPE_SPOT = found.index; // e.g. "@107"
      }catch(e){ showErr('spotMeta', e.message || e); } // non-fatal
    }

    // ========= Builders revenue (24h) via HypurrScan proxy =========
    async function loadBuildersRev(){
      try{
        const r = await fetch('/api/builders');
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const rows = await r.json();
        // Sum top rows (API may already be 24h)
        const sum = (Array.isArray(rows)? rows : []).slice(0, 20)
                     .reduce((s,x)=> s + Number(x.revenue||0), 0);
        $('builders-rev').textContent = `$${(sum/1000).toFixed(2)}k`;
      }catch(e){
        $('builders-rev').textContent = '—';
        showErr('builders', e.message || e);
      }
    }

    // ========= Your Staked (per address) =========
    async function loadYourStaked(addr){
      if(!addr){ $('staked').textContent = '—'; return; }
      try{
        const r = await fetch(HL_INFO, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ type:'delegatorSummary', user: addr })
        });
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const s = await r.json();
        if(s && s.delegated){ $('staked').textContent = `${Number(s.delegated).toFixed(2)} HYPE`; }
        else { $('staked').textContent = '—'; }
      }catch(e){ $('staked').textContent = '—'; showErr('delegatorSummary', e.message || e); }
    }

    // Wire address input
    (function setupAddr(){
      const saved = localStorage.getItem('hl_addr')||'';
      if(saved) $('addr').value = saved, loadYourStaked(saved);
      $('addrSave').onclick = () => {
        const a = ($('addr').value||'').trim();
        localStorage.setItem('hl_addr', a);
        loadYourStaked(a);
      };
    })();

    // ========= Live chart via WebSocket =========
    let chart;
    function renderChart(series){
      const ctx = $('priceChart');
      const data = { labels: series.map(p=>p.t), datasets:[{ label:'Price', data: series.map(p=>p.v) }] };
      if(chart) chart.destroy();
      chart = new Chart(ctx, { type:'line', data });
    }
    function connectWS(){
      try{
        const ws = new WebSocket(HL_WS);
        ws.onopen = () => {
          ws.send(JSON.stringify({ method:'subscribe', subscription:{ type:'candle', coin:HYPE_SPOT, interval:'1m' }}));
        };
        ws.onmessage = (ev) => {
          try{
            const m = JSON.parse(ev.data||'{}');
            if(m.channel==='candle' && Array.isArray(m.data)){
              const series = m.data.slice(-120).map(c=>({
                t: new Date(c.t).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
                v: Number(c.c)
              }));
              renderChart(series);
            }
          }catch(e){ showErr('ws message', e.message || e); }
        };
        ws.onerror = () => showErr('ws', 'connection error');
        ws.onclose  = () => setTimeout(connectWS, 3000);
      }catch(e){ showErr('ws init', e.message || e); }
    }

    // ========= Boot =========
    (async () => {
      await detectHypeId();    // sets HYPE_SPOT if spotMeta is reachable
      await loadKPIs();        // CG: price/24h/volume
      await loadBuildersRev(); // HypurrScan: 24h revenue
      connectWS();             // live 1m candles
    })();
  </script>
</body>
</html>
