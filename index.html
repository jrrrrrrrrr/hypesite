<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HYPE Dashboard</title>
  <script>
  // --- Config (all through your Vercel proxies) ---
  const HL_INFO = '/api/hl';
  const HL_WS   = 'wss://api.hyperliquid.xyz/ws';
  let   HYPE_SPOT = '@107'; // will auto-detect below
  const CG_ID  = 'hyperliquid';

  // Small helpers
  const $ = (id) => document.getElementById(id);
  const fmtMoneyM = (n) => `$${(Number(n||0)/1_000_000).toFixed(2)}M`;

  // CoinGecko KPIs
  async function fetchCG() {
    const r = await fetch(`/api/cg?id=${encodeURIComponent(CG_ID)}`);
    if (!r.ok) return null;
    const arr = await r.json();
    return Array.isArray(arr) && arr.length ? arr[0] : null;
  }

  async function loadKPIs() {
    const cg = await fetchCG();
    if (cg) {
      $('price').textContent = `$${Number(cg.current_price||0).toFixed((cg.current_price||0)<1?4:2)}`;
      const chg = Number(cg.price_change_percentage_24h||0);
      $('price-change').textContent = `24h: ${chg>=0?'+':''}${chg.toFixed(2)}%`;
      $('volume').textContent = fmtMoneyM(cg.total_volume||0);
    }
  }

  // Auto-detect HYPE spot index for WS candles
  async function detectHypeId() {
    try {
      const r = await fetch(HL_INFO, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ type: 'spotMeta' })
      });
      const meta = await r.json();
      const uni = meta?.universe || meta?.spotMeta?.universe || [];
      const found = uni.find(u => String(u?.name||u?.token||'').toUpperCase().includes('HYPE'));
      if (found?.index) HYPE_SPOT = found.index;
    } catch { /* non-fatal */ }
  }

  // Live chart via WS
  let chart;
  function renderChart(series){
    const ctx = document.getElementById('priceChart');
    const data = { labels: series.map(p=>p.t), datasets:[{ label:'Price', data: series.map(p=>p.v) }] };
    if (chart) chart.destroy();
    chart = new Chart(ctx, { type:'line', data });
  }
  function connectWS(){
    const ws = new WebSocket(HL_WS);
    ws.onopen = () => {
      ws.send(JSON.stringify({ method:'subscribe', subscription:{ type:'candle', coin:HYPE_SPOT, interval:'1m' }}));
    };
    ws.onmessage = (ev) => {
      try{
        const m = JSON.parse(ev.data||'{}');
        if (m.channel==='candle' && Array.isArray(m.data)) {
          const series = m.data.slice(-120).map(c => ({
            t: new Date(c.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            v: Number(c.c)
          }));
          renderChart(series);
        }
      } catch {}
    };
    ws.onclose = () => setTimeout(connectWS, 3000);
  }

  // Builders revenue (24h) via HypurrScan proxy
  async function loadBuildersRev(){
    try{
      const r = await fetch('/api/builders');
      if(!r.ok) throw new Error('builders api failed');
      const rows = await r.json(); // expect array of { name, revenue, code, timeframe? }
      // If API returns mixed timeframes, filter to 24h; otherwise just sum top N
      const sum = rows.slice(0, 20).reduce((s, x) => s + Number(x.revenue||0), 0);
      $('builders-rev').textContent = `$${(sum/1000).toFixed(2)}k`;
    }catch{
      $('builders-rev').textContent = 'â€”';
    }
  }

  // Optional: show "Your Staked" using an address (if you want anything here today)
  async function loadYourStaked(addr){
    try{
      const r = await fetch(HL_INFO, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ type:'delegatorSummary', user: addr })
      });
      if(!r.ok) return;
      const s = await r.json();
      if (s && s.delegated) $('staked').textContent = `${Number(s.delegated).toFixed(2)} HYPE`;
    }catch{}
  }

  (async () => {
    await detectHypeId();   // set correct WS coin id
    await loadKPIs();       // fill price, change, volume
    await loadBuildersRev();// fill builders 24h
    connectWS();            // live chart
    // If you want a quick personal staked value, uncomment and paste your address:
    // loadYourStaked('0xYourAddressHere');
  })();
</script>
</body>
</html>

