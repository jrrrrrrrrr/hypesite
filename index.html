<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HYPE Intelligence Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,300;0,400;0,500;0,600;1,300&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<style>
  :root {
    --bg: #060a0e;
    --surface: #0c1219;
    --surface2: #111820;
    --border: #1a2430;
    --border-bright: #263545;
    --accent: #00d4ff;
    --accent2: #ff5e1a;
    --accent-dim: rgba(0,212,255,0.1);
    --accent2-dim: rgba(255,94,26,0.1);
    --text: #b8ccd8;
    --text-dim: #4a6678;
    --text-bright: #ddeeff;
    --red: #ff3d50;
    --red-dim: rgba(255,61,80,0.1);
    --green: #00e676;
    --green-dim: rgba(0,230,118,0.1);
    --yellow: #ffcc44;
    --yellow-dim: rgba(255,204,68,0.1);
    --purple: #bb86fc;
    --purple-dim: rgba(187,134,252,0.1);
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'IBM Plex Sans', sans-serif;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{background:var(--bg);color:var(--text);font-family:var(--mono);font-size:12px;line-height:1.5;overflow:hidden}
  body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.015) 3px,rgba(0,0,0,.015) 4px);pointer-events:none;z-index:9999}

  /* TOPBAR */
  .topbar{height:48px;display:flex;align-items:center;padding:0 16px;border-bottom:1px solid var(--border);background:var(--surface);gap:16px;position:relative;z-index:10;flex-shrink:0}
  .logo{font-size:14px;font-weight:600;letter-spacing:.12em;color:var(--accent);white-space:nowrap}
  .logo em{color:var(--text-dim);font-style:normal;font-weight:300}
  .logo .ver{font-size:8px;color:var(--accent2);vertical-align:super;margin-left:3px;letter-spacing:.05em}
  .divider{width:1px;height:24px;background:var(--border)}
  .live-badge{display:flex;align-items:center;gap:5px;font-size:10px;letter-spacing:.1em;color:var(--text-dim)}
  .live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);animation:blink 2s ease-in-out infinite}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
  .price-hero{display:flex;align-items:baseline;gap:6px}
  .price-main{font-size:18px;font-weight:600;color:var(--text-bright);font-variant-numeric:tabular-nums;letter-spacing:-.01em}
  .price-chg{font-size:11px;font-weight:500}
  .up{color:var(--green)}.down{color:var(--red)}
  .topbar-stats{display:flex;align-items:center;gap:16px;margin-left:auto}
  .ts{display:flex;flex-direction:column;align-items:flex-end}
  .ts-l{font-size:9px;letter-spacing:.1em;color:var(--text-dim);text-transform:uppercase}
  .ts-v{font-size:12px;font-weight:500;font-variant-numeric:tabular-nums;color:var(--text-bright)}
  .ts-v.a{color:var(--accent)}.ts-v.b{color:var(--accent2)}.ts-v.r{color:var(--red)}.ts-v.g{color:var(--green)}
  .btn{background:none;border:1px solid var(--border-bright);color:var(--text-dim);font-family:var(--mono);font-size:10px;letter-spacing:.08em;padding:4px 10px;cursor:pointer;border-radius:2px;transition:all .15s;white-space:nowrap}
  .btn:hover{border-color:var(--accent);color:var(--accent)}
  .btn.busy{opacity:.5;pointer-events:none}

  /* LAYOUT */
  .layout{display:grid;grid-template-columns:210px 1fr 250px;height:calc(100vh - 48px);overflow:hidden}

  /* SIDEBAR LEFT */
  .sb-left{border-right:1px solid var(--border);overflow-y:auto;display:flex;flex-direction:column}
  .sb-sec{padding:11px 13px;border-bottom:1px solid var(--border)}
  .sb-lbl{font-size:9px;font-weight:600;letter-spacing:.15em;text-transform:uppercase;color:var(--text-dim);margin-bottom:9px;display:flex;align-items:center;gap:5px}
  .sb-lbl .dot{width:4px;height:4px;border-radius:50%;background:var(--accent)}
  .sb-row{display:flex;justify-content:space-between;align-items:baseline;padding:3px 0}
  .sb-k{color:var(--text-dim);font-size:10px}
  .sb-v{font-size:11px;font-weight:500;color:var(--text-bright);font-variant-numeric:tabular-nums}
  .sb-v.a{color:var(--accent)}.sb-v.b{color:var(--accent2)}.sb-v.g{color:var(--green)}.sb-v.r{color:var(--red)}.sb-v.y{color:var(--yellow)}
  .sig-box{margin-top:4px;padding:9px;border-radius:3px;text-align:center}
  .sig-lbl{font-size:15px;font-weight:700;letter-spacing:.1em}
  .sig-sub{font-size:9px;color:var(--text-dim);margin-top:2px;font-family:var(--sans)}

  /* CENTER MAIN */
  .main{display:flex;flex-direction:column;overflow:hidden;border-right:1px solid var(--border)}
  .tabs{display:flex;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;overflow-x:auto}
  .tab{padding:9px 13px;font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;display:flex;align-items:center;gap:4px;white-space:nowrap}
  .tab:hover{color:var(--text)}
  .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
  .tab.new-tab{color:var(--accent2)}
  .tab.new-tab.active{color:var(--accent2);border-bottom-color:var(--accent2)}
  .tbadge{background:var(--accent-dim);color:var(--accent);border-radius:2px;padding:0 4px;font-size:9px;min-width:14px;text-align:center}
  .tbadge.r{background:var(--red-dim);color:var(--red)}
  .tbadge.new{background:var(--accent2-dim);color:var(--accent2)}
  .content{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:12px}

  /* PANELS */
  .panel{background:var(--surface);border:1px solid var(--border);border-radius:3px;overflow:hidden}
  .ph{display:flex;justify-content:space-between;align-items:center;padding:8px 13px;border-bottom:1px solid var(--border);background:var(--surface2)}
  .ptitle{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);display:flex;align-items:center;gap:5px}
  .pdot{width:5px;height:5px;border-radius:50%}
  .pmeta{font-size:10px;color:var(--text-dim)}

  /* KPIs */
  .kgrid{display:grid;gap:10px}
  .kg3{grid-template-columns:repeat(3,1fr)}
  .kg4{grid-template-columns:repeat(4,1fr)}
  .kg2{grid-template-columns:repeat(2,1fr)}
  .twocol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .threecol{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .kpi{background:var(--surface);border:1px solid var(--border);border-top:2px solid transparent;border-radius:3px;padding:11px 13px;position:relative}
  .kpi.ca{border-top-color:var(--accent)}.kpi.cb{border-top-color:var(--accent2)}.kpi.cg{border-top-color:var(--green)}.kpi.cr{border-top-color:var(--red)}.kpi.cy{border-top-color:var(--yellow)}.kpi.cp{border-top-color:var(--purple)}
  .kl{font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text-dim);margin-bottom:4px;display:flex;align-items:center;gap:4px}
  .kv{font-size:20px;font-weight:600;color:var(--text-bright);font-variant-numeric:tabular-nums;line-height:1.2}
  .ks{font-size:10px;color:var(--text-dim);margin-top:3px;font-family:var(--sans)}
  .ks.g{color:var(--green)}.ks.r{color:var(--red)}

  /* TOOLTIP / INFO ICON */
  .info-ico{display:inline-flex;align-items:center;justify-content:center;width:13px;height:13px;border-radius:50%;background:var(--border);color:var(--text-dim);font-size:8px;font-weight:700;cursor:help;font-style:normal;flex-shrink:0;transition:all .15s}
  .info-ico:hover{background:var(--accent);color:var(--bg)}
  .tooltip-wrap{position:relative}
  .tooltip-content{display:none;position:absolute;top:calc(100% + 6px);left:0;z-index:100;width:280px;padding:10px 12px;background:var(--surface2);border:1px solid var(--accent);border-radius:4px;font-size:10px;color:var(--text);line-height:1.6;font-family:var(--sans);font-weight:300;box-shadow:0 8px 32px rgba(0,0,0,.5)}
  .tooltip-content::before{content:'';position:absolute;top:-5px;left:12px;width:10px;height:10px;background:var(--surface2);border-left:1px solid var(--accent);border-top:1px solid var(--accent);transform:rotate(45deg)}
  .tooltip-content .tt-title{font-size:10px;font-weight:600;color:var(--accent);letter-spacing:.08em;text-transform:uppercase;margin-bottom:5px;font-family:var(--mono)}
  .tooltip-content .tt-what{color:var(--text-bright);margin-bottom:4px}
  .tooltip-content .tt-why{color:var(--text);margin-bottom:4px}
  .tooltip-content .tt-high{color:var(--green)}
  .tooltip-content .tt-low{color:var(--red)}
  .info-ico:hover + .tooltip-content,.tooltip-content:hover{display:block}

  /* FEED */
  .fi{display:grid;grid-template-columns:88px 1fr auto;gap:9px;align-items:start;padding:7px 13px;border-bottom:1px solid rgba(26,36,48,.7);transition:background .1s}
  .fi:last-child{border-bottom:none}
  .fi:hover{background:rgba(17,24,32,.8)}
  .fi-t{font-size:10px;color:var(--text-dim);font-variant-numeric:tabular-nums;line-height:1.4}
  .fi-d{font-size:11px;color:var(--text);line-height:1.5}
  .fi-a{color:var(--accent);cursor:pointer;text-decoration:none}
  .fi-a:hover{text-decoration:underline}
  .fi-amt{font-size:12px;font-weight:600;text-align:right;font-variant-numeric:tabular-nums;white-space:nowrap;line-height:1.4}
  .fi-usd{font-size:10px;color:var(--text-dim);font-variant-numeric:tabular-nums}
  .bdg{display:inline-flex;align-items:center;padding:1px 5px;border-radius:2px;font-size:9px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;margin-bottom:1px}
  .bk{background:var(--accent-dim);color:var(--accent)}
  .bu{background:var(--red-dim);color:var(--red)}
  .bb{background:var(--accent2-dim);color:var(--accent2)}
  .bg{background:var(--green-dim);color:var(--green)}
  .by{background:var(--yellow-dim);color:var(--yellow)}
  .bt{background:rgba(74,102,120,.15);color:var(--text-dim)}
  .bp{background:var(--purple-dim);color:var(--purple)}

  /* QUEUE ITEM */
  .qi{display:grid;grid-template-columns:1fr auto 90px;gap:10px;align-items:center;padding:8px 13px;border-bottom:1px solid rgba(26,36,48,.7)}
  .qi:last-child{border-bottom:none}
  .qi:hover{background:var(--surface2)}
  .qi-addr{color:var(--accent);font-size:11px;cursor:pointer}
  .qi-addr:hover{text-decoration:underline}
  .qi-sub{font-size:9px;color:var(--text-dim);margin-top:1px}
  .qi-amt{font-size:13px;font-weight:700;color:var(--red);text-align:right;font-variant-numeric:tabular-nums}
  .qi-usd{font-size:10px;color:var(--text-dim);text-align:right}
  .qi-cd{font-size:11px;font-variant-numeric:tabular-nums;text-align:right}
  .qi-pct{font-size:9px;color:var(--text-dim);margin-top:1px;text-align:right}
  .prog{height:2px;background:var(--border);border-radius:1px;overflow:hidden;margin-top:4px}
  .prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:1px}

  /* VALIDATORS */
  .vtbl{width:100%;border-collapse:collapse}
  .vtbl th{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);padding:7px 13px;text-align:left;border-bottom:1px solid var(--border);background:var(--surface2);white-space:nowrap}
  .vtbl td{padding:7px 13px;font-size:11px;border-bottom:1px solid rgba(26,36,48,.5);font-variant-numeric:tabular-nums}
  .vtbl tr:last-child td{border-bottom:none}
  .vtbl tr:hover td{background:rgba(17,24,32,.6)}
  .vname{display:flex;align-items:center;gap:5px;font-weight:500;color:var(--text-bright)}
  .vdot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
  .vbcell{display:flex;align-items:center;gap:5px;min-width:90px}
  .vbar{flex:1;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
  .vbar-fill{height:100%;background:var(--accent);border-radius:2px}

  /* AF */
  .af-info{padding:11px 13px;background:rgba(0,212,255,.03);border-bottom:1px solid rgba(0,212,255,.1);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .af-addr{font-size:10px;color:var(--accent);letter-spacing:.04em}
  .af-desc{font-size:9px;color:var(--text-dim);margin-top:1px;font-family:var(--sans)}
  .af-link{margin-left:auto;color:var(--text-dim);font-size:10px;text-decoration:none;border:1px solid var(--border);padding:2px 7px;border-radius:2px;white-space:nowrap}
  .af-link:hover{border-color:var(--accent);color:var(--accent)}

  /* FEE BARS */
  .fee-chart{padding:12px;display:flex;flex-direction:column;gap:5px}
  .fbrow{display:flex;align-items:center;gap:7px}
  .fblabel{font-size:9px;color:var(--text-dim);width:44px;text-align:right;flex-shrink:0}
  .fbout{flex:1;height:15px;background:var(--border);border-radius:2px;overflow:hidden;position:relative}
  .fbin{height:100%;background:linear-gradient(90deg,var(--accent2) 0%,rgba(255,94,26,.5) 100%);border-radius:2px;transition:width .5s ease}
  .fbval{position:absolute;right:5px;top:50%;transform:translateY(-50%);font-size:9px;color:var(--text-bright);font-variant-numeric:tabular-nums;white-space:nowrap}

  /* INSIGHT */
  .insight{background:rgba(0,212,255,.04);border:1px solid rgba(0,212,255,.12);border-radius:3px;padding:11px 13px}
  .insight-ttl{font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--accent);margin-bottom:7px}
  .insight-body{font-size:11px;color:var(--text);line-height:1.7;font-family:var(--sans)}
  .insight-body strong{color:var(--text-bright);font-family:var(--mono)}

  /* RIGHT SIDEBAR */
  .sb-right{overflow-y:auto;display:flex;flex-direction:column}
  .sr-sec{padding:11px 13px;border-bottom:1px solid var(--border)}
  .sr-ttl{font-size:9px;font-weight:700;letter-spacing:.15em;text-transform:uppercase;color:var(--text-dim);margin-bottom:9px}
  .alert-row{display:flex;align-items:flex-start;gap:7px;padding:6px 0;border-bottom:1px solid rgba(26,36,48,.5);font-size:10px;font-family:var(--sans);color:var(--text);line-height:1.5}
  .alert-row:last-child{border-bottom:none}
  .alert-ico{font-size:11px;flex-shrink:0;margin-top:1px}
  .holder-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0;border-bottom:1px solid rgba(26,36,48,.4);font-size:10px}
  .holder-row:last-child{border-bottom:none}
  .h-rank{color:var(--text-dim);width:14px;flex-shrink:0}
  .h-addr{color:var(--accent);flex:1;padding:0 5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer}
  .h-addr:hover{text-decoration:underline}
  .h-amt{font-variant-numeric:tabular-nums;color:var(--text-bright);font-weight:500}

  /* TAB PANELS */
  .tp{display:none}.tp.active{display:flex;flex-direction:column;gap:12px}

  /* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
  .chart-outer{background:var(--surface);border:1px solid var(--border);border-radius:3px;overflow:hidden;display:flex;flex-direction:column}
  .chart-toolbar{display:flex;align-items:center;gap:0;padding:0 12px;border-bottom:1px solid var(--border);background:var(--surface2);flex-shrink:0;height:32px}
  .ct-btn{background:none;border:none;font-family:var(--mono);font-size:9px;font-weight:600;letter-spacing:.1em;color:var(--text-dim);cursor:pointer;padding:6px 9px;text-transform:uppercase;border-bottom:2px solid transparent;height:32px;transition:color .12s,border-color .12s}
  .ct-btn:hover{color:var(--text)}
  .ct-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
  .ct-sep{width:1px;height:14px;background:var(--border);margin:0 6px;flex-shrink:0}
  .ct-type{background:none;border:1px solid var(--border);font-family:var(--mono);font-size:9px;color:var(--text-dim);cursor:pointer;padding:2px 7px;border-radius:2px;margin-left:2px;transition:all .12s}
  .ct-type:hover{border-color:var(--accent);color:var(--accent)}
  .ct-type.active{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
  .chart-stats{display:flex;gap:18px;padding:7px 13px;border-bottom:1px solid var(--border);flex-wrap:wrap;flex-shrink:0;background:var(--surface2)}
  .cst-item{display:flex;flex-direction:column;gap:1px}
  .cst-lbl{font-size:8px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.1em}
  .cst-val{font-size:11px;font-weight:600;font-variant-numeric:tabular-nums;color:var(--text-bright)}
  .chart-canvas-wrap{position:relative;width:100%;height:280px;flex-shrink:0}
  .chart-canvas-wrap.short{height:200px}
  /* AF LIVE MONITOR */
  .af-live-stats{display:flex;gap:20px;padding:8px 13px;border-bottom:1px solid var(--border);background:rgba(0,212,255,0.03);flex-wrap:wrap;flex-shrink:0}

  /* KPIs with sparklines */
  .kpi-sparkline{width:100%;height:36px;margin-top:6px;opacity:0.7}
  /* Validator donut */
  .val-donut-wrap{display:flex;align-items:center;gap:16px;padding:12px 13px}
  .val-legend{flex:1;display:flex;flex-direction:column;gap:4px;min-width:0}
  .val-legend-row{display:flex;justify-content:space-between;align-items:center;font-size:10px;padding:2px 0;border-bottom:1px solid rgba(26,36,48,.5)}
  .val-legend-row:last-child{border-bottom:none}
  .val-legend-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-right:5px}
  .val-legend-name{flex:1;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:flex;align-items:center}
  .val-legend-pct{color:var(--text-bright);font-weight:600;font-variant-numeric:tabular-nums;margin-left:8px;flex-shrink:0}
  /* Unstaking histogram */
  .unstake-histogram{padding:10px 13px 6px;display:flex;flex-direction:column;gap:4px}
  .uh-row{display:flex;align-items:center;gap:6px}
  .uh-lbl{font-size:9px;color:var(--text-dim);width:36px;text-align:right;flex-shrink:0}
  .uh-bar{flex:1;height:14px;background:var(--border);border-radius:2px;overflow:hidden;position:relative}
  .uh-fill{height:100%;border-radius:2px;transition:width .5s ease}
  .uh-val{position:absolute;right:5px;top:50%;transform:translateY(-50%);font-size:9px;color:var(--text-bright);font-variant-numeric:tabular-nums;white-space:nowrap}
  /* Fee chart canvas */
  .fee-canvas-wrap{padding:0 8px 8px;position:relative}
  #feeChartCanvas{display:block}
  /* Overview grid with sparklines */
  .kpi .kpi-canvas{display:block;width:100%;height:32px;margin-top:5px;opacity:.6}

  /* ‚îÄ‚îÄ WALLET INTELLIGENCE ‚îÄ‚îÄ */
  .wallet-input-wrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .wallet-input{flex:1;min-width:200px;background:var(--surface);border:1px solid var(--border);color:var(--text-bright);font-family:var(--mono);font-size:12px;padding:8px 12px;border-radius:3px;outline:none;transition:border-color .15s}
  .wallet-input:focus{border-color:var(--accent)}
  .wallet-input::placeholder{color:var(--text-dim)}
  .wallet-btn{background:var(--accent-dim);border:1px solid var(--accent);color:var(--accent);font-family:var(--mono);font-size:10px;letter-spacing:.1em;padding:8px 16px;cursor:pointer;border-radius:3px;font-weight:600;text-transform:uppercase;transition:all .15s}
  .wallet-btn:hover{background:var(--accent);color:var(--bg)}
  .wallet-btn.busy{opacity:.5;pointer-events:none}
  .wallet-saved{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .wallet-tag{background:var(--surface2);border:1px solid var(--border);color:var(--text);font-size:9px;padding:3px 8px;border-radius:2px;cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .15s}
  .wallet-tag:hover{border-color:var(--accent);color:var(--accent)}
  .wallet-tag .tag-x{color:var(--text-dim);font-size:8px;cursor:pointer}
  .wallet-tag .tag-x:hover{color:var(--red)}

  /* POSITION ROW */
  .pos-row{display:grid;grid-template-columns:80px 1fr auto auto auto;gap:12px;align-items:center;padding:8px 13px;border-bottom:1px solid rgba(26,36,48,.7)}
  .pos-row:last-child{border-bottom:none}
  .pos-row:hover{background:var(--surface2)}
  .pos-coin{font-weight:600;color:var(--text-bright);font-size:12px}
  .pos-side{font-size:9px;font-weight:700;letter-spacing:.08em}
  .pos-long{color:var(--green)}.pos-short{color:var(--red)}
  .pos-val{font-size:11px;font-variant-numeric:tabular-nums;text-align:right}

  /* MARKET EXPLORER */
  .mkt-row{display:grid;grid-template-columns:100px repeat(6,1fr);gap:8px;align-items:center;padding:8px 13px;border-bottom:1px solid rgba(26,36,48,.7);font-size:11px;font-variant-numeric:tabular-nums}
  .mkt-row:hover{background:var(--surface2)}
  .mkt-row.hdr{background:var(--surface2);font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);border-bottom:1px solid var(--border)}
  .mkt-coin{font-weight:600;color:var(--text-bright);display:flex;align-items:center;gap:4px}
  .mkt-funding{font-weight:600}
  .mkt-funding.pos{color:var(--green)}.mkt-funding.neg{color:var(--red)}

  /* GLOBAL STATS GRID */
  .gs-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}

  /* LEARNING CARD */
  .learn-card{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:14px;margin-bottom:8px}
  .learn-card h3{font-size:11px;font-weight:600;color:var(--accent);letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px}
  .learn-card p{font-size:11px;font-family:var(--sans);color:var(--text);line-height:1.7;margin-bottom:6px}
  .learn-card .example{background:var(--surface2);border-left:2px solid var(--accent2);padding:8px 12px;margin:6px 0;font-size:10px;line-height:1.6;color:var(--text);font-family:var(--sans)}
  .learn-card .hl{color:var(--green)}.learn-card .rl{color:var(--red)}

  /* ‚îÄ‚îÄ LIVE TRADE TICKER ‚îÄ‚îÄ */
  .live-ticker{max-height:160px;overflow-y:auto}
  .tick-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:9px;font-variant-numeric:tabular-nums;border-bottom:1px solid rgba(26,36,48,.3);animation:tickIn .3s ease}
  .tick-row:last-child{border-bottom:none}
  @keyframes tickIn{from{opacity:0;transform:translateX(-4px)}to{opacity:1;transform:none}}
  .tick-buy{color:var(--green)}.tick-sell{color:var(--red)}
  .tick-coin{color:var(--text-bright);font-weight:500;width:42px}
  .tick-time{color:var(--text-dim);font-size:8px}
  .ws-badge{display:flex;align-items:center;gap:4px;font-size:9px;letter-spacing:.08em;color:var(--text-dim)}
  .ws-dot{width:5px;height:5px;border-radius:50%;background:var(--text-dim);transition:all .3s}
  .ws-dot.connected{background:var(--accent);box-shadow:0 0 4px var(--accent)}
  .ws-dot.error{background:var(--red);box-shadow:0 0 4px var(--red)}

  /* ‚îÄ‚îÄ ORDER BOOK DEPTH ‚îÄ‚îÄ */
  .ob-wrap{display:grid;grid-template-columns:1fr 1fr;gap:0;font-size:10px;font-variant-numeric:tabular-nums}
  .ob-side{display:flex;flex-direction:column}
  .ob-hdr{display:flex;justify-content:space-between;padding:4px 10px;font-size:8px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);background:var(--surface2);border-bottom:1px solid var(--border)}
  .ob-row{display:flex;align-items:center;padding:2px 10px;position:relative;height:20px}
  .ob-row .ob-bg{position:absolute;top:0;bottom:0;height:100%}
  .ob-bids .ob-bg{right:0;background:rgba(0,230,118,.08)}
  .ob-asks .ob-bg{left:0;background:rgba(255,61,80,.08)}
  .ob-px{flex:1;z-index:1;font-weight:500}
  .ob-sz{flex:1;text-align:right;z-index:1;color:var(--text-dim)}
  .ob-bids .ob-px{color:var(--green)}.ob-asks .ob-px{color:var(--red)}
  .ob-spread{text-align:center;padding:4px;font-size:9px;color:var(--text-dim);background:var(--surface2);border-top:1px solid var(--border);border-bottom:1px solid var(--border)}

  /* ‚îÄ‚îÄ FUNDING CHART ‚îÄ‚îÄ */
  .funding-chart-wrap{position:relative;width:100%;height:180px;flex-shrink:0}

  /* ‚îÄ‚îÄ WALLET TABS ‚îÄ‚îÄ */
  .wtabs{display:flex;border-bottom:1px solid var(--border);background:var(--surface)}
  .wtab{padding:7px 12px;font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;transition:all .12s}
  .wtab:hover{color:var(--text)}
  .wtab.active{color:var(--accent);border-bottom-color:var(--accent)}
  .wtp{display:none}.wtp.active{display:block}
  .fill-row{display:grid;grid-template-columns:50px 70px 1fr 1fr 1fr auto;gap:6px;align-items:center;padding:5px 13px;border-bottom:1px solid rgba(26,36,48,.5);font-size:10px;font-variant-numeric:tabular-nums}
  .fill-row:hover{background:var(--surface2)}
  .fill-row.fhdr{font-size:8px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);background:var(--surface2)}
  .fund-row{display:grid;grid-template-columns:70px 1fr 1fr 1fr;gap:8px;align-items:center;padding:5px 13px;border-bottom:1px solid rgba(26,36,48,.5);font-size:10px;font-variant-numeric:tabular-nums}
  .fund-row:hover{background:var(--surface2)}
  .fund-row.fhdr{font-size:8px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);background:var(--surface2)}

  /* EMPTY */
  .es{padding:20px;text-align:center;color:var(--text-dim);font-size:11px;font-family:var(--sans)}
  .es a{color:var(--accent);text-decoration:none}
  .es a:hover{text-decoration:underline}
  .skel{background:linear-gradient(90deg,var(--border) 25%,var(--border-bright) 50%,var(--border) 75%);background-size:200% 100%;animation:shim 1.4s infinite;border-radius:2px;display:inline-block;height:11px}
  @keyframes shim{0%{background-position:200% 0}100%{background-position:-200% 0}}

  ::-webkit-scrollbar{width:3px;height:3px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:var(--border-bright);border-radius:2px}

  @media(max-width:1100px){.layout{grid-template-columns:200px 1fr}.sb-right{display:none}}
  @media(max-width:760px){.layout{grid-template-columns:1fr}.sb-left{display:none}.topbar-stats .ts:nth-child(n+3){display:none}}
</style>
</head>
<body>

<header class="topbar">
  <div class="logo">HYPE<em>/</em>INTEL<span class="ver">v2</span></div>
  <div class="divider"></div>
  <div class="live-badge">
    <div class="live-dot" id="liveDot"></div>
    <span id="liveText">CONNECTING</span>
  </div>
  <div class="divider"></div>
  <div class="ws-badge">
    <div class="ws-dot" id="wsDot"></div>
    <span id="wsText">WS</span>
  </div>
  <div class="divider"></div>
  <div class="price-hero">
    <div class="price-main" id="topPrice">$‚Äî</div>
    <div class="price-chg" id="topChg">‚Äî</div>
  </div>
  <div class="topbar-stats">
    <div class="ts"><div class="ts-l">Staked</div><div class="ts-v a" id="tsStaked">‚Äî</div></div>
    <div class="ts"><div class="ts-l">Burned</div><div class="ts-v b" id="tsBurned">‚Äî</div></div>
    <div class="ts"><div class="ts-l">Queue</div><div class="ts-v r" id="tsQueue">‚Äî</div></div>
    <div class="ts"><div class="ts-l">24h Fees</div><div class="ts-v g" id="tsFees">‚Äî</div></div>
    <div class="ts"><div class="ts-l">Mkt Cap</div><div class="ts-v" id="tsMcap">‚Äî</div></div>
    <div class="ts"><div class="ts-l">Updated</div><div class="ts-v" id="tsUpdated">‚Äî</div></div>
    <button class="btn" id="refreshBtn" onclick="loadAll()">‚Üª REFRESH</button>
  </div>
</header>

<div class="layout">

  <!-- LEFT SIDEBAR -->
  <aside class="sb-left">
    <div class="sb-sec">
      <div class="sb-lbl"><div class="dot"></div>Supply</div>
      <div class="sb-row"><span class="sb-k">Max Supply</span><span class="sb-v">1.00B HYPE</span></div>
      <div class="sb-row"><span class="sb-k">Circulating</span><span class="sb-v" id="sbCirc">‚Äî</span></div>
      <div class="sb-row"><span class="sb-k">Total Burned</span><span class="sb-v b" id="sbBurned">‚Äî</span></div>
      <div class="sb-row"><span class="sb-k">Burned %</span><span class="sb-v" id="sbBurnPct">‚Äî</span></div>
    </div>
    <div class="sb-sec">
      <div class="sb-lbl"><div class="dot" style="background:var(--green)"></div>Staking</div>
      <div class="sb-row"><span class="sb-k">Total Staked</span><span class="sb-v a" id="sbStaked">‚Äî</span></div>
      <div class="sb-row"><span class="sb-k">Staked %</span><span class="sb-v" id="sbStakedPct">‚Äî</span></div>
      <div class="sb-row"><span class="sb-k">Queue Total</span><span class="sb-v r" id="sbQTotal">‚Äî</span></div>
      <div class="sb-row"><span class="sb-k">Queue Count</span><span class="sb-v" id="sbQCount">‚Äî</span></div>
      <div class="sb-row"><span class="sb-k">Staking APR</span><span class="sb-v g" id="sbApr">‚Äî</span></div>
      <div class="sb-row"><span class="sb-k">Validators</span><span class="sb-v" id="sbVals">‚Äî</span></div>
    </div>
    <div class="sb-sec">
      <div class="sb-lbl"><div class="dot" style="background:var(--accent2)"></div>AF &amp; Burns</div>
      <div class="sb-row"><span class="sb-k">AF Balance</span><span class="sb-v g" id="sbAfBal">‚Äî</span></div>
      <div class="sb-row"><span class="sb-k">AF Bids</span><span class="sb-v y" id="sbAfBids">‚Äî</span></div>
      <div class="sb-row"><span class="sb-k">Burn Rate</span><span class="sb-v b" id="sbBurnRate">‚Äî</span></div>
    </div>
    <div class="sb-sec">
      <div class="sb-lbl"><div class="dot" style="background:var(--yellow)"></div>Market</div>
      <div class="sb-row"><span class="sb-k">Price</span><span class="sb-v" id="sbPrice">‚Äî</span></div>
      <div class="sb-row"><span class="sb-k">Mkt Cap</span><span class="sb-v" id="sbMcap">‚Äî</span></div>
      <div class="sb-row"><span class="sb-k">24h Volume</span><span class="sb-v" id="sbVol">‚Äî</span></div>
      <div class="sb-row"><span class="sb-k">FDV</span><span class="sb-v" id="sbFdv">‚Äî</span></div>
    </div>
    <div class="sb-sec">
      <div class="sb-lbl"><div class="dot" style="background:var(--purple)"></div>Platform</div>
      <div class="sb-row"><span class="sb-k">Total OI</span><span class="sb-v" id="sbTotalOI">‚Äî</span></div>
      <div class="sb-row"><span class="sb-k">24h Vol (Perps)</span><span class="sb-v" id="sbPerpVol">‚Äî</span></div>
    </div>
    <div class="sb-sec">
      <div class="sb-lbl"><div class="dot" style="background:var(--purple)"></div>Signal</div>
      <div id="signalBox"><div class="sig-box" style="background:var(--surface2)"><div class="sig-lbl" style="color:var(--text-dim)">‚Äî</div><div class="sig-sub">Loading...</div></div></div>
    </div>
  </aside>

  <!-- CENTER MAIN -->
  <div class="main">
    <nav class="tabs">
      <div class="tab active" data-tab="overview">Overview</div>
      <div class="tab" data-tab="charts">Charts</div>
      <div class="tab" data-tab="globalstats" data-new="1">Global Stats <span class="tbadge new">NEW</span></div>
      <div class="tab" data-tab="markets" data-new="1">Markets <span class="tbadge new">NEW</span></div>
      <div class="tab" data-tab="wallet" data-new="1">Wallet Intel <span class="tbadge new">NEW</span></div>
      <div class="tab" data-tab="unstaking">Unstaking <span class="tbadge r" id="tbUQ">0</span></div>
      <div class="tab" data-tab="staking">Staking Flows</div>
      <div class="tab" data-tab="af">AF &amp; Burns</div>
      <div class="tab" data-tab="fees">Fees</div>
      <div class="tab" data-tab="validators">Validators</div>
    </nav>

    <div class="content">

      <!-- OVERVIEW -->
      <div class="tp active" id="tab-overview">
        <div class="kgrid kg3">
          <div class="kpi ca"><div class="kl">Total Staked <span class="tooltip-wrap"><i class="info-ico">?</i><div class="tooltip-content"><div class="tt-title">Total Staked</div><div class="tt-what">HYPE tokens locked in validator staking contracts.</div><div class="tt-why">Reduces circulating supply. Higher staking = less sell pressure, more network security.</div><div class="tt-high">‚ñ≤ High (>35%): Strong conviction, limited float.</div><div class="tt-low">‚ñº Low (<15%): Weak lockup, higher sell pressure risk.</div></div></span></div><div class="kv" id="kStaked">‚Äî</div><div class="ks" id="kStakedS">‚Äî</div><canvas class="kpi-canvas" id="sparkStaked" height="32"></canvas></div>
          <div class="kpi cb"><div class="kl">Total Burned <span class="tooltip-wrap"><i class="info-ico">?</i><div class="tooltip-content"><div class="tt-title">Total Burned</div><div class="tt-what">HYPE permanently removed via fee-funded buybacks sent to dead address.</div><div class="tt-why">Deflationary mechanism. Higher burn = less supply over time = upward price pressure.</div><div class="tt-high">‚ñ≤ Rising: Protocol generating fees, active usage.</div><div class="tt-low">‚ñº Flat: Low platform activity or low HYPE price.</div></div></span></div><div class="kv" id="kBurned">‚Äî</div><div class="ks" id="kBurnedS">‚Äî</div><canvas class="kpi-canvas" id="sparkBurned" height="32"></canvas></div>
          <div class="kpi cr"><div class="kl">Pending Unstake <span class="tooltip-wrap"><i class="info-ico">?</i><div class="tooltip-content"><div class="tt-title">Pending Unstake Queue</div><div class="tt-what">HYPE currently in 8-day unlock cooldown period.</div><div class="tt-why">Leading indicator of potential sell pressure. Large queues suggest validators or whales preparing to exit.</div><div class="tt-high">‚ñ≤ Large (>500K): Significant upcoming sell pressure.</div><div class="tt-low">‚ñº Small (<50K): Minimal exit pressure, bullish signal.</div></div></span></div><div class="kv" id="kQueue">‚Äî</div><div class="ks" id="kQueueS">‚Äî</div><canvas class="kpi-canvas" id="sparkQueue" height="32"></canvas></div>
        </div>
        <div class="twocol">
          <div class="insight" id="insightPanel"><div class="insight-ttl">üì° Trading Intelligence</div><div class="insight-body" id="insightBody">Loading...</div></div>
          <div class="panel"><div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--accent2)"></div>24h Fee Revenue</div><div class="pmeta" id="feeMetaLabel">‚Äî</div></div><div class="fee-chart" id="feeChart24h"><div class="es"><span class="skel" style="width:120px"></span></div></div></div>
        </div>
        <div class="panel"><div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--green)"></div>Live Activity Feed</div><div class="pmeta">Delegations + Transfers ¬∑ Most recent first</div></div><div id="overviewFeed"><div class="es"><span class="skel" style="width:200px"></span></div></div></div>
      </div>

      <!-- CHARTS TAB -->
      <div class="tp" id="tab-charts">
        <!-- LIVE AF MONITOR CHART -->
        <div class="chart-outer">
          <div class="ph">
            <div class="ptitle"><div class="pdot" style="background:var(--green)"></div>AF Live Monitor ‚Äî HYPE Price vs Bid vs Fees</div>
            <div class="pmeta" id="afChartMeta">Updating every 5s ¬∑ Hyperliquid API</div>
          </div>
          <div class="af-live-stats" id="afLiveStats">
            <div class="cst-item"><div class="cst-lbl">HYPE Price</div><div class="cst-val" style="color:var(--accent)" id="afLivePrice">‚Äî</div></div>
            <div class="cst-item"><div class="cst-lbl">AF Bid Price</div><div class="cst-val" style="color:var(--red)" id="afLiveBid">‚Äî</div></div>
            <div class="cst-item"><div class="cst-lbl">Bid Size</div><div class="cst-val" style="color:var(--yellow)" id="afLiveSz">‚Äî</div></div>
            <div class="cst-item"><div class="cst-lbl">AF USDC Balance</div><div class="cst-val" style="color:var(--accent2)" id="afLiveUsdc">‚Äî</div></div>
            <div class="cst-item"><div class="cst-lbl">Fees Collected (session)</div><div class="cst-val" style="color:var(--purple)" id="afLiveFees">‚Äî</div></div>
            <div class="cst-item"><div class="cst-lbl">Spread to Bid</div><div class="cst-val" id="afLiveSpread">‚Äî</div></div>
          </div>
          <div class="chart-canvas-wrap" id="afWrap"></div>
        </div>

        <!-- PRICE CANDLESTICK CHART -->
        <div class="chart-outer">
          <div class="ph">
            <div class="ptitle"><div class="pdot" style="background:var(--accent)"></div>HYPE / USD ‚Äî Price History</div>
            <div class="pmeta" id="priceChartMeta">Hyperliquid spot ¬∑ candleSnapshot</div>
          </div>
          <div class="chart-toolbar">
            <button class="ct-btn active" data-ptf="60"    onclick="loadPriceChart(60,this)">1H</button>
            <button class="ct-btn"        data-ptf="240"   onclick="loadPriceChart(240,this)">4H</button>
            <button class="ct-btn"        data-ptf="1440"  onclick="loadPriceChart(1440,this)">1D</button>
            <button class="ct-btn"        data-ptf="10080" onclick="loadPriceChart(10080,this)">1W</button>
            <div class="ct-sep"></div>
            <button class="ct-type active" id="btnCandle" onclick="setPriceType('candle')">Candle</button>
            <button class="ct-type"        id="btnArea"   onclick="setPriceType('area')">Area</button>
          </div>
          <div class="chart-stats">
            <div class="cst-item"><div class="cst-lbl">Open</div><div class="cst-val" id="csO">‚Äî</div></div>
            <div class="cst-item"><div class="cst-lbl">High</div><div class="cst-val" style="color:var(--green)" id="csH">‚Äî</div></div>
            <div class="cst-item"><div class="cst-lbl">Low</div><div class="cst-val" style="color:var(--red)" id="csL">‚Äî</div></div>
            <div class="cst-item"><div class="cst-lbl">Close</div><div class="cst-val" id="csC">‚Äî</div></div>
            <div class="cst-item"><div class="cst-lbl">Change</div><div class="cst-val" id="csChg">‚Äî</div></div>
            <div class="cst-item"><div class="cst-lbl">Volume</div><div class="cst-val" style="color:var(--text-dim)" id="csVol">‚Äî</div></div>
          </div>
          <div class="chart-canvas-wrap" id="priceWrap"></div>
        </div>

        <!-- CUMULATIVE BURN CHART -->
        <div class="chart-outer">
          <div class="ph">
            <div class="ptitle"><div class="pdot" style="background:var(--accent2)"></div>HYPE Burned ‚Äî Cumulative (from fees)</div>
            <div class="pmeta">Implied burn: fees √∑ price ¬∑ feesRecent API</div>
          </div>
          <div class="chart-toolbar">
            <button class="ct-btn active" data-btf="24"  onclick="setBurnWindow(24,this)">24H</button>
            <button class="ct-btn"        data-btf="168" onclick="setBurnWindow(168,this)">7D</button>
            <button class="ct-btn"        data-btf="720" onclick="setBurnWindow(720,this)">30D</button>
            <button class="ct-btn"        data-btf="0"   onclick="setBurnWindow(0,this)">All</button>
          </div>
          <div class="chart-stats">
            <div class="cst-item"><div class="cst-lbl">Total Burned</div><div class="cst-val" style="color:var(--accent2)" id="bsTotal">‚Äî</div></div>
            <div class="cst-item"><div class="cst-lbl">Period Burns</div><div class="cst-val" style="color:var(--yellow)" id="bsPeriod">‚Äî</div></div>
            <div class="cst-item"><div class="cst-lbl">USD Value</div><div class="cst-val" style="color:var(--text-dim)" id="bsUsd">‚Äî</div></div>
            <div class="cst-item"><div class="cst-lbl">Rate</div><div class="cst-val" style="color:var(--text-dim)" id="bsRate">‚Äî</div></div>
          </div>
          <div class="chart-canvas-wrap short" id="burnWrap"></div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê NEW: GLOBAL STATS ‚ïê‚ïê‚ïê -->
      <div class="tp" id="tab-globalstats">
        <div class="kgrid kg4">
          <div class="kpi ca"><div class="kl">24h Platform Volume <span class="tooltip-wrap"><i class="info-ico">?</i><div class="tooltip-content"><div class="tt-title">24h Platform Volume</div><div class="tt-what">Total notional trading volume across all perpetual markets in 24 hours.</div><div class="tt-why">Measures platform activity and liquidity. Fee revenue is directly proportional to volume.</div><div class="tt-high">‚ñ≤ High: Active trading, high fee generation for burns.</div><div class="tt-low">‚ñº Low: Reduced activity, lower burn rate.</div></div></span></div><div class="kv" id="gsVol24">‚Äî</div><div class="ks" id="gsVol24S">Across all perp markets</div></div>
          <div class="kpi cg"><div class="kl">Total Open Interest <span class="tooltip-wrap"><i class="info-ico">?</i><div class="tooltip-content"><div class="tt-title">Total Open Interest</div><div class="tt-what">Sum of all outstanding perpetual futures positions (both long and short).</div><div class="tt-why">Measures capital deployed. Rising OI + rising price = new money entering longs (bullish). Rising OI + falling price = new shorts opening.</div><div class="tt-high">‚ñ≤ High OI: Heavy positioning, potential for volatility.</div><div class="tt-low">‚ñº Low OI: Less leveraged exposure, calmer market.</div></div></span></div><div class="kv" id="gsTotalOI">‚Äî</div><div class="ks" id="gsTotalOIS">All perpetual markets</div></div>
          <div class="kpi cy"><div class="kl">Active Markets</div><div class="kv" id="gsMarkets">‚Äî</div><div class="ks">Perpetual pairs listed</div></div>
          <div class="kpi cp"><div class="kl">Insurance Fund <span class="tooltip-wrap"><i class="info-ico">?</i><div class="tooltip-content"><div class="tt-title">Insurance Fund</div><div class="tt-what">Backstop fund that absorbs losses from liquidations that exceed account equity.</div><div class="tt-why">Prevents socialized losses. Larger fund = safer exchange. Depleting fund = systemic risk signal.</div></div></span></div><div class="kv" id="gsInsurance">‚Äî</div><div class="ks">Platform safety backstop</div></div>
        </div>

        <div class="panel">
          <div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--accent)"></div>Top Markets by Open Interest</div><div class="pmeta" id="gsTopOIMeta">Hyperliquid perp markets</div></div>
          <div id="gsTopOIList"><div class="es"><span class="skel" style="width:200px"></span></div></div>
        </div>

        <div class="twocol">
          <div class="panel">
            <div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--green)"></div>Top Markets by 24h Volume</div><div class="pmeta">Sorted by notional volume</div></div>
            <div id="gsTopVolList"><div class="es"><span class="skel" style="width:180px"></span></div></div>
          </div>
          <div class="panel">
            <div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--yellow)"></div>Funding Rate Snapshot <span class="tooltip-wrap"><i class="info-ico">?</i><div class="tooltip-content"><div class="tt-title">Funding Rates</div><div class="tt-what">Periodic payments between long and short traders. Positive = longs pay shorts. Negative = shorts pay longs.</div><div class="tt-why">Reflects market sentiment. Persistently high positive funding = overcrowded longs, often precedes mean reversion down. Persistently negative = shorts paying, squeeze potential.</div><div class="tt-high">‚ñ≤ Positive: Bullish sentiment, longs paying premium.</div><div class="tt-low">‚ñº Negative: Bearish sentiment, shorts paying premium.</div></div></span></div><div class="pmeta">Current 8h rates ¬∑ top markets</div></div>
            <div id="gsFundingList"><div class="es"><span class="skel" style="width:180px"></span></div></div>
          </div>
        </div>

        <div class="insight" style="border-color:rgba(187,134,252,.2);background:rgba(187,134,252,.03)">
          <div class="insight-ttl" style="color:var(--purple)">üìä Platform Analytics Summary</div>
          <div class="insight-body" id="gsSummary">Loading global stats...</div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê NEW: MARKET EXPLORER ‚ïê‚ïê‚ïê -->
      <div class="tp" id="tab-markets">
        <div class="panel">
          <div class="ph">
            <div class="ptitle"><div class="pdot" style="background:var(--accent)"></div>Perpetual Markets Explorer</div>
            <div class="pmeta">All active perp markets ¬∑ Sorted by OI</div>
          </div>
          <div id="mktExplorer">
            <div class="mkt-row hdr">
              <div>Market</div><div style="text-align:right">Price</div><div style="text-align:right">24h Change</div>
              <div style="text-align:right">Open Interest</div><div style="text-align:right">24h Volume</div>
              <div style="text-align:right">Funding (8h)</div><div style="text-align:right">Premium</div>
            </div>
            <div class="es"><span class="skel" style="width:300px"></span></div>
          </div>
        </div>

        <div class="panel" id="mktDetailPanel" style="display:none">
          <div class="ph">
            <div class="ptitle"><div class="pdot" style="background:var(--yellow)"></div><span id="mktDetailTitle">Market Detail</span></div>
            <div class="pmeta"><button class="btn" onclick="closeMktDetail()">‚úï Close</button></div>
          </div>
          <div class="kgrid kg3" style="padding:12px">
            <div class="kpi ca"><div class="kl">Open Interest</div><div class="kv" id="mdOI">‚Äî</div></div>
            <div class="kpi cg"><div class="kl">24h Volume</div><div class="kv" id="mdVol">‚Äî</div></div>
            <div class="kpi cy"><div class="kl">Funding Rate</div><div class="kv" id="mdFunding">‚Äî</div></div>
          </div>
          <div class="chart-canvas-wrap" id="mktDetailChartWrap" style="height:220px"></div>

          <!-- Funding History Chart -->
          <div class="ph" style="margin-top:-1px">
            <div class="ptitle"><div class="pdot" style="background:var(--purple)"></div>Funding Rate History (7d) <span class="tooltip-wrap"><i class="info-ico">?</i><div class="tooltip-content"><div class="tt-title">Funding Rate History</div><div class="tt-what">Shows how funding rates have changed over time for this market.</div><div class="tt-why">Persistently positive funding means longs are overcrowded and paying a premium. Extreme spikes often precede mean-reversion moves. Negative funding indicates short crowding.</div></div></span></div>
            <div class="pmeta" id="mdFundingMeta">fundingHistory API</div>
          </div>
          <div class="funding-chart-wrap" id="mdFundingChartWrap"></div>

          <!-- L2 Order Book Depth -->
          <div class="ph" style="margin-top:-1px">
            <div class="ptitle"><div class="pdot" style="background:var(--green)"></div>Order Book Depth (L2) <span class="tooltip-wrap"><i class="info-ico">?</i><div class="tooltip-content"><div class="tt-title">L2 Order Book</div><div class="tt-what">Real-time bid/ask depth showing resting limit orders at each price level.</div><div class="tt-why">Thick bids = strong support. Thin asks = low resistance. Imbalances can predict short-term price direction.</div></div></span></div>
            <div class="pmeta" id="mdBookMeta">20 levels per side</div>
          </div>
          <div id="mdOrderBook"><div class="es">Click a market to load order book</div></div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê NEW: WALLET INTELLIGENCE ‚ïê‚ïê‚ïê -->
      <div class="tp" id="tab-wallet">
        <div class="panel">
          <div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--accent)"></div>Wallet Intelligence <span class="tooltip-wrap"><i class="info-ico">?</i><div class="tooltip-content"><div class="tt-title">Wallet Intelligence</div><div class="tt-what">Lookup any Hyperliquid address to view their positions, PnL, and trading activity.</div><div class="tt-why">Track whale activity, analyze strategies, and monitor high-conviction traders. Uses Hyperliquid's clearinghouse API.</div></div></span></div><div class="pmeta">Enter any Hyperliquid address</div></div>
          <div style="padding:12px">
            <div class="wallet-input-wrap">
              <input type="text" class="wallet-input" id="walletAddr" placeholder="0x... paste any Hyperliquid address" spellcheck="false">
              <button class="wallet-btn" id="walletLookupBtn" onclick="lookupWallet()">üîç LOOKUP</button>
              <button class="wallet-btn" style="background:var(--accent2-dim);border-color:var(--accent2);color:var(--accent2)" onclick="saveWatchAddr()">‚òÖ SAVE</button>
              <a class="wallet-btn" id="walletImpLink" href="#" target="_blank" style="display:none;text-decoration:none;background:var(--purple-dim);border-color:var(--purple);color:var(--purple)">‚Üó VIEW ON HL</a>
            </div>
            <div class="wallet-saved" id="whaleWatchList"></div>
          </div>
        </div>

        <div id="walletResults" style="display:none">
          <div class="kgrid kg4">
            <div class="kpi ca"><div class="kl">Account Value</div><div class="kv" id="wAccVal">‚Äî</div><div class="ks" id="wAccValS">Perps + Spot</div></div>
            <div class="kpi cg"><div class="kl">Total PnL <span class="tooltip-wrap"><i class="info-ico">?</i><div class="tooltip-content"><div class="tt-title">Total PnL</div><div class="tt-what">Unrealized profit/loss across all open perpetual positions.</div><div class="tt-why">Shows current portfolio performance. Extreme unrealized PnL often precedes position closing.</div></div></span></div><div class="kv" id="wPnl">‚Äî</div><div class="ks" id="wPnlS">Unrealized P&L</div></div>
            <div class="kpi cy"><div class="kl">Margin Used</div><div class="kv" id="wMargin">‚Äî</div><div class="ks" id="wMarginS">Cross margin</div></div>
            <div class="kpi cp"><div class="kl">Open Positions</div><div class="kv" id="wPosCount">‚Äî</div><div class="ks">Active perp trades</div></div>
          </div>

          <div class="twocol">
            <div class="panel">
              <div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--green)"></div>Open Positions</div><div class="pmeta" id="wPosMeta">Perpetual positions</div></div>
              <div id="wPositions"><div class="es">No positions</div></div>
            </div>
            <div class="panel">
              <div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--yellow)"></div>Spot Holdings</div><div class="pmeta">Token balances</div></div>
              <div id="wSpotHoldings"><div class="es">No spot holdings</div></div>
            </div>
          </div>

          <div class="panel">
            <div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--purple)"></div>Open Orders</div><div class="pmeta" id="wOrdersMeta">Resting orders</div></div>
            <div id="wOpenOrders"><div class="es">No open orders</div></div>
          </div>

          <!-- Trade Fills & Funding History -->
          <div class="panel">
            <div class="wtabs">
              <div class="wtab active" onclick="switchWalletTab(this,'wtp-fills')">Recent Fills</div>
              <div class="wtab" onclick="switchWalletTab(this,'wtp-funding')">Funding Payments</div>
            </div>
            <div class="wtp active" id="wtp-fills">
              <div id="wFillsList"><div class="es">Lookup an address to see trade fills</div></div>
            </div>
            <div class="wtp" id="wtp-funding">
              <div id="wFundingList"><div class="es">Lookup an address to see funding payments</div></div>
            </div>
          </div>
        </div>
      </div>


      <!-- UNSTAKING -->
      <div class="tp" id="tab-unstaking">
        <div class="kgrid kg3">
          <div class="kpi cr"><div class="kl">Total Queued</div><div class="kv" id="kuTotal">‚Äî</div><div class="ks" id="kuTotalS">‚Äî</div></div>
          <div class="kpi cy"><div class="kl">Unlocking ‚â§24h</div><div class="kv" id="kuSoon">‚Äî</div><div class="ks">Immediate sell pressure risk</div></div>
          <div class="kpi ca"><div class="kl">Avg Position</div><div class="kv" id="kuAvg">‚Äî</div><div class="ks">Per unstaking wallet</div></div>
        </div>
        <div class="panel"><div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--yellow)"></div>Unlock Timeline ‚Äî HYPE by Day</div><div class="pmeta" id="unstakeHistMeta">Distribution over 8-day window</div></div><div class="unstake-histogram" id="unstakeHistogram"><div class="es"><span class="skel" style="width:180px"></span></div></div></div>
        <div class="panel"><div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--red)"></div>Full Unstaking Queue</div><div class="pmeta">Live ¬∑ /fullUnstakingQueue ¬∑ 8-day lock ¬∑ Sorted by size</div></div><div id="queueList"><div class="es"><span class="skel" style="width:180px"></span></div></div></div>
      </div>

      <!-- STAKING FLOWS -->
      <div class="tp" id="tab-staking">
        <div class="twocol">
          <div class="panel"><div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--accent)"></div>Recent Delegations</div><div class="pmeta">/delegations</div></div><div id="stakeFeed"><div class="es"><span class="skel" style="width:140px"></span></div></div></div>
          <div class="panel"><div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--red)"></div>Recent Undelegations</div><div class="pmeta">/delegations</div></div><div id="unstakeFeed"><div class="es"><span class="skel" style="width:140px"></span></div></div></div>
        </div>
        <div class="panel"><div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--purple)"></div>Validator Stake Distribution</div><div class="pmeta">Top validators by delegated HYPE</div></div><div class="val-donut-wrap" id="valDistWrap"><canvas id="valDonut" width="120" height="120"></canvas><div class="val-legend" id="valLegend"><div class="es"><span class="skel" style="width:100px"></span></div></div></div></div>
        <div class="panel"><div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--yellow)"></div>üêã Whale Movements (‚â•10K HYPE)</div><div class="pmeta">High-impact stake events</div></div><div id="whaleFeed"><div class="es"><span class="skel" style="width:140px"></span></div></div></div>
      </div>

      <!-- AF & BURNS -->
      <div class="tp" id="tab-af">
        <div class="panel">
          <div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--accent)"></div>Assistance Fund Wallet</div><div class="pmeta">0xfefe‚Ä¶fefe ¬∑ System address</div></div>
          <div class="af-info">
            <div><div class="af-addr">0xfefefefefefefefefefefefefefefefefefefefe</div><div class="af-desc">Trading fees ‚Üí auto buys HYPE ‚Üí permanent burn. No private key exists.</div></div>
            <a href="https://hypurrscan.io/address/0xfefefefefefefefefefefefefefefefefefefefe" target="_blank" class="af-link">HypurrScan ‚Üó</a>
            <a href="https://www.hypeburn.fun/" target="_blank" class="af-link">HypeBurn ‚Üó</a>
          </div>
          <div id="afTxFeed"><div class="es"><span class="skel" style="width:180px"></span></div></div>
        </div>
        <div class="twocol">
          <div class="panel"><div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--accent2)"></div>Burn Events</div><div class="pmeta">From /transfers to burn address</div></div><div id="burnFeed"><div class="es"><span class="skel" style="width:140px"></span></div></div></div>
          <div class="panel"><div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--yellow)"></div>AF Open Buy Bids</div><div class="pmeta">Live HYPE/USDC orderbook</div></div><div id="afBidsFeed"><div class="es"><span class="skel" style="width:140px"></span></div></div></div>
        </div>
      </div>

      <!-- FEES -->
      <div class="tp" id="tab-fees">
        <div class="kgrid kg3">
          <div class="kpi cp"><div class="kl">Fees All Time</div><div class="kv" id="kFeeAll">‚Äî</div><div class="ks">Cumulative protocol revenue</div></div>
          <div class="kpi cg"><div class="kl">Fees Last 24h</div><div class="kv" id="kFee24">‚Äî</div><div class="ks">‚Üí converted to HYPE burns</div></div>
          <div class="kpi cb"><div class="kl">Implied Burn Rate <span class="tooltip-wrap"><i class="info-ico">?</i><div class="tooltip-content"><div class="tt-title">Implied Burn Rate</div><div class="tt-what">Estimated HYPE tokens burned per day based on current fee revenue and HYPE price.</div><div class="tt-why">Burn rate = 24h fees / HYPE price. Higher price means fewer HYPE burned per dollar of fees. Lower price means more HYPE burned.</div></div></span></div><div class="kv" id="kFeeRate">‚Äî</div><div class="ks">HYPE/day at current price</div></div>
        </div>
        <div class="panel"><div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--purple)"></div>48h Fee History</div><div class="pmeta">api.hypurrscan.io/feesRecent</div></div><div class="fee-canvas-wrap"><canvas id="feeChartCanvas" height="160"></canvas></div></div>
        <div class="panel"><div class="ph"><div class="ptitle"><div class="pdot" style="background:var(--accent2)"></div>Fee History ‚Äî Bar View</div><div class="pmeta">Last 20 periods</div></div><div class="fee-chart" id="feeChart48h"><div class="es"><span class="skel" style="width:200px"></span></div></div></div>
      </div>

      <!-- VALIDATORS -->
      <div class="tp" id="tab-validators">
        <div class="panel"><div class="ph"><div class="ptitle"><div class="pdot"></div>Validator Set</div><div class="pmeta">Hyperliquid validatorSummaries API ¬∑ Sorted by stake</div></div>
          <table class="vtbl"><thead><tr><th>Validator</th><th>Stake</th><th>Share</th><th>Commission</th><th>Est. APR</th><th>Status</th></tr></thead>
          <tbody id="valRows"><tr><td colspan="6" class="es"><span class="skel" style="width:200px"></span></td></tr></tbody></table>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->

  <!-- RIGHT SIDEBAR -->
  <aside class="sb-right">
    <div class="sr-sec"><div class="sr-ttl">‚ö° Live Trades</div><div class="live-ticker" id="liveTrades"><div style="font-size:9px;color:var(--text-dim)">Connecting WebSocket...</div></div></div>
    <div class="sr-sec"><div class="sr-ttl">üö® Live Alerts</div><div id="alertsPanel"><div class="alert-row"><span class="alert-ico">‚è≥</span> Loading...</div></div></div>
    <div class="sr-sec"><div class="sr-ttl">üèÜ Top HYPE Holders</div><div id="topHolders"><div class="es"><span class="skel" style="width:130px"></span></div></div></div>
    <div class="sr-sec"><div class="sr-ttl">üìä Fee Trend (48h)</div><canvas id="feeSparkline" width="224" height="56"></canvas></div>
    <div class="sr-sec">
      <div class="sr-ttl">üìà Platform Snapshot</div>
      <div id="rightPlatformStats" style="font-size:10px">
        <div class="sb-row"><span class="sb-k">Perp Vol 24h</span><span class="sb-v" id="rsPerpVol">‚Äî</span></div>
        <div class="sb-row"><span class="sb-k">Total OI</span><span class="sb-v" id="rsTotalOI">‚Äî</span></div>
        <div class="sb-row"><span class="sb-k">Top Funding</span><span class="sb-v" id="rsTopFunding">‚Äî</span></div>
        <div class="sb-row"><span class="sb-k">Markets</span><span class="sb-v" id="rsMarkets">‚Äî</span></div>
      </div>
    </div>
    <div class="sr-sec">
      <div class="sr-ttl">üîó Quick Links</div>
      <div style="display:flex;flex-direction:column;gap:5px;margin-top:2px">
        <a href="https://www.hypeburn.fun/" target="_blank" style="color:var(--accent);font-size:10px;text-decoration:none">HypeBurn.fun ‚Üó</a>
        <a href="https://hypurrscan.io/staking" target="_blank" style="color:var(--accent);font-size:10px;text-decoration:none">HypurrScan Staking ‚Üó</a>
        <a href="https://hypurrscan.io/address/0xfefefefefefefefefefefefefefefefefefefefe" target="_blank" style="color:var(--accent);font-size:10px;text-decoration:none">Assistance Fund Wallet ‚Üó</a>
        <a href="https://app.hyperliquid.xyz/trade/HYPE" target="_blank" style="color:var(--accent);font-size:10px;text-decoration:none">Trade HYPE ‚Üó</a>
        <a href="https://hyperliquid.gitbook.io/hyperliquid-docs/trading/fees" target="_blank" style="color:var(--accent);font-size:10px;text-decoration:none">Fees Documentation ‚Üó</a>
        <a href="https://api.hypurrscan.io/ui" target="_blank" style="color:var(--text-dim);font-size:10px;text-decoration:none">HypurrScan API Docs ‚Üó</a>
      </div>
    </div>
    <div class="sr-sec">
      <div class="sr-ttl">üì° Data Sources</div>
      <div style="font-size:9px;color:var(--text-dim);font-family:var(--sans);line-height:1.7">
        <div>‚Ä¢ Hyperliquid Info API (POST)</div>
        <div>‚Ä¢ Hyperliquid WebSocket (wss://)</div>
        <div>‚Ä¢ HypurrScan REST API</div>
        <div>‚Ä¢ All data fetched client-side</div>
        <div>‚Ä¢ WS: live allMids + trades</div>
        <div>‚Ä¢ REST: 15s price, 90s full refresh</div>
        <div style="margin-top:4px;color:var(--text)">Endpoints: allMids, metaAndAssetCtxs, l2Book, fundingHistory, userFills, userFunding, candleSnapshot, clearinghouseState, openOrders, stakingSummary, validatorSummaries</div>
      </div>
    </div>
  </aside>

</div><!-- /layout -->

<script>
// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HL    = 'https://api.hyperliquid.xyz/info';
const HS    = 'https://api.hypurrscan.io';
const AF    = '0xfefefefefefefefefefefefefefefefefefefefe';
const BURN  = '0x000000000000000000000000000000000000dead';
const MAX_S = 1_000_000_000;

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const D = {
  price:null, priceChg:null, vol24:null,
  staked:null, apr:null, circSupply:null,
  validators:[], queue:[], delegations:[],
  transfers:[], feesRecent:[], feesAll:null,
  fees24:null, afBal:null, afUsdc:null, afOrders:[],
  holders:{}, burned:null,
  // NEW: Global stats
  perpMeta:null, perpCtxs:[], allMids:{},
  totalOI:null, totalPerpVol:null, markets:[],
};

// ‚îÄ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const F = {
  c:   n => { if(n==null)return'‚Äî'; n=+n; if(n>=1e9)return(n/1e9).toFixed(2)+'B'; if(n>=1e6)return(n/1e6).toFixed(2)+'M'; if(n>=1e3)return(n/1e3).toFixed(1)+'K'; return n.toFixed(2); },
  f2:  n => n==null?'‚Äî':Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}),
  f4:  n => n==null?'‚Äî':Number(n).toLocaleString('en-US',{minimumFractionDigits:4,maximumFractionDigits:4}),
  pct: n => n==null?'‚Äî':(n>=0?'+':'')+Number(n).toFixed(2)+'%',
  pct4:n => n==null?'‚Äî':(n>=0?'+':'')+Number(n).toFixed(4)+'%',
  addr:a => a?`${a.slice(0,6)}‚Ä¶${a.slice(-4)}`:'‚Äî',
  usd: n => n==null?'‚Äî':'$'+F.c(n),
  t:   ts => { if(!ts)return'‚Äî'; const d=new Date(+ts); return d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}); },
  ago: ts => { const s=(Date.now()-+ts)/1000; if(s<60)return Math.floor(s)+'s'; if(s<3600)return Math.floor(s/60)+'m'; if(s<86400)return Math.floor(s/3600)+'h'; return Math.floor(s/86400)+'d'; },
  cd:  ts => {
    const ms=+ts-Date.now(); if(ms<=0)return{txt:'READY üîì',urgent:true,pct:100};
    const d=Math.floor(ms/86400000),h=Math.floor((ms%86400000)/3600000),m=Math.floor((ms%3600000)/60000);
    return{txt:`${d}d ${h}h ${m}m`,urgent:d===0,pct:Math.max(0,Math.min(100,(1-ms/(8*86400000))*100))};
  }
};

// ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function hl(body) {
  const r = await fetch(HL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!r.ok) throw new Error('HL '+r.status);
  return r.json();
}
async function hs(path) {
  try { const r=await fetch(HS+path); if(!r.ok)return null; return r.json(); } catch(e){return null;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEBSOCKET LIVE FEED ‚Äî allMids + trades streams
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WS_URL = 'wss://api.hyperliquid.xyz/ws';
let _ws = null, _wsRetries = 0, _wsReconnTimer = null;
let _liveTrades = []; // last N trades
const MAX_LIVE_TRADES = 30;
const _wsSubscribedCoins = ['BTC','ETH','HYPE','SOL','DOGE']; // top coins for trade feed

function _wsConnect() {
  if(_ws && (_ws.readyState === WebSocket.OPEN || _ws.readyState === WebSocket.CONNECTING)) return;
  try {
    _ws = new WebSocket(WS_URL);
    _ws.onopen = () => {
      _wsRetries = 0;
      _wsSetStatus('connected');
      // Subscribe to allMids for real-time price
      _ws.send(JSON.stringify({method:'subscribe', subscription:{type:'allMids'}}));
      // Subscribe to trades for top coins
      _wsSubscribedCoins.forEach(coin => {
        _ws.send(JSON.stringify({method:'subscribe', subscription:{type:'trades', coin}}));
      });
    };
    _ws.onmessage = (evt) => {
      try {
        const msg = JSON.parse(evt.data);
        if(msg.channel === 'allMids' && msg.data?.mids) {
          // Real-time price update
          const px = parseFloat(msg.data.mids['@107'] || msg.data.mids['HYPE'] || 0);
          if(px) {
            D.price = px;
            set('topPrice', '$' + F.f2(px));
            set('sbPrice', '$' + F.f2(px));
            set('tsUpdated', new Date().toLocaleTimeString());
          }
          D.allMids = msg.data.mids;
        } else if(msg.channel === 'trades' && Array.isArray(msg.data)) {
          // Live trade events
          msg.data.forEach(t => {
            _liveTrades.unshift({
              coin: t.coin || '?',
              side: t.side || '?',
              px: parseFloat(t.px || 0),
              sz: parseFloat(t.sz || 0),
              time: t.time || Date.now(),
              hash: t.hash || ''
            });
          });
          if(_liveTrades.length > MAX_LIVE_TRADES) _liveTrades = _liveTrades.slice(0, MAX_LIVE_TRADES);
          _renderLiveTrades();
        }
      } catch(e) {}
    };
    _ws.onclose = () => { _wsSetStatus('disconnected'); _wsScheduleReconnect(); };
    _ws.onerror = () => { _wsSetStatus('error'); };
  } catch(e) { _wsSetStatus('error'); _wsScheduleReconnect(); }
}

function _wsScheduleReconnect() {
  if(_wsReconnTimer) clearTimeout(_wsReconnTimer);
  const delay = Math.min(30000, 1000 * Math.pow(2, _wsRetries));
  _wsRetries++;
  _wsReconnTimer = setTimeout(_wsConnect, delay);
}

function _wsSetStatus(state) {
  const dot = $('wsDot'), txt = $('wsText');
  if(!dot||!txt) return;
  dot.className = 'ws-dot ' + (state === 'connected' ? 'connected' : state === 'error' ? 'error' : '');
  txt.textContent = state === 'connected' ? 'WS LIVE' : state === 'error' ? 'WS ERR' : 'WS OFF';
}

function _renderLiveTrades() {
  const el = $('liveTrades');
  if(!el) return;
  if(!_liveTrades.length) { el.innerHTML = '<div style="font-size:9px;color:var(--text-dim)">Waiting for trades...</div>'; return; }
  el.innerHTML = _liveTrades.slice(0, 15).map(t => {
    const clr = t.side === 'B' ? 'tick-buy' : 'tick-sell';
    const dir = t.side === 'B' ? '‚ñ≤' : '‚ñº';
    return `<div class="tick-row"><span class="tick-coin">${t.coin}</span><span class="${clr}">${dir} $${t.px < 1 ? F.f4(t.px) : F.f2(t.px)}</span><span style="color:var(--text-dim)">${F.c(t.sz)}</span><span class="tick-time">${F.t(t.time)}</span></div>`;
  }).join('');
}

// Start WebSocket on page load
setTimeout(_wsConnect, 500);

// ‚îÄ‚îÄ‚îÄ FETCHERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fPrice() {
  const m = await hl({type:'allMids'});
  D.allMids = m;
  const px = m['@107']||m['HYPE'];
  if(px) D.price = parseFloat(px);
}
async function fSpot() {
  try {
    const [meta, ctxs] = await hl({type:'spotMetaAndAssetCtxs'});
    if(ctxs&&ctxs[107]) {
      const c=ctxs[107];
      if(c.dayNtlVlm) D.vol24=parseFloat(c.dayNtlVlm);
      if(c.prevDayPx&&D.price) D.priceChg=((D.price-parseFloat(c.prevDayPx))/parseFloat(c.prevDayPx))*100;
      if(c.circulatingSupply) D.circSupply=parseFloat(c.circulatingSupply);
    }
  } catch(e){}
}
async function fStaking() {
  try {
    const d=await hl({type:'stakingSummary'});
    if(d){
      const staked=d.totalStaked||d.total_staked||d.stakedAmount||d.staked||d.totalDelegated;
      if(staked) D.staked=parseFloat(staked);
      const apr=d.stakingApr||d.apr||d.annualizedReturn||d.yield;
      if(apr!=null) D.apr=parseFloat(apr);
      if(d.totalBurned||d.burnedSupply) D.burned=parseFloat(d.totalBurned||d.burnedSupply);
      console.log('[staking]',JSON.stringify(d).slice(0,300));
    }
  } catch(e){}
  if(!D.staked && D.validators.length) {
    const tot=D.validators.reduce((s,v)=>s+parseFloat(v.stake||v.totalStake||v.stakedAmount||0),0);
    if(tot>0) D.staked=tot;
  }
}
async function fValidators() {
  try {
    const d=await hl({type:'validatorSummaries'});
    if(Array.isArray(d)) {
      D.validators=d.sort((a,b)=>parseFloat(b.stake||b.totalStake||b.stakedAmount||b.amount||0)-parseFloat(a.stake||a.totalStake||a.stakedAmount||a.amount||0));
      console.log('[validator sample]',JSON.stringify(D.validators[0]).slice(0,400));
    }
  } catch(e){}
}
async function fAfBal() {
  try {
    const d=await hl({type:'spotClearinghouseState',user:AF});
    if(d?.balances){
      const h=d.balances.find(b=>b.coin==='HYPE');
      if(h) D.afBal=parseFloat(h.hold||h.total||h.available||0);
      const u=d.balances.find(b=>b.coin==='USDC');
      if(u) D.afUsdc=parseFloat(u.total||u.hold||u.available||0);
    }
  } catch(e){}
}
async function fAfOrders() {
  try { const d=await hl({type:'openOrders',user:AF}); if(Array.isArray(d)) D.afOrders=d.filter(o=>o.side==='B'); } catch(e){}
}
async function fDelegations() {
  const d=await hs('/delegations');
  if(Array.isArray(d)&&d.length) { D.delegations=d; }
}
async function fQueue() {
  let d=await hs('/fullUnstakingQueue');
  if(d){
    const arr=Array.isArray(d)?d:(d.queue||d.data||d.entries||[]);
    if(arr.length){ D.queue=arr; return; }
  }
  d=await hs('/unstakingQueue');
  if(d){ const arr=Array.isArray(d)?d:(d.queue||d.data||[]); D.queue=arr; }
}
async function fTransfers() {
  let d=await hs('/aLotOfTransfers'); if(Array.isArray(d)&&d.length){D.transfers=d;return;}
  d=await hs('/transfers'); if(Array.isArray(d)) D.transfers=d;
}
async function fFees() {
  const [recent,all]=await Promise.all([hs('/feesRecent'),hs('/fees')]);
  if(Array.isArray(recent)&&recent.length){
    D.feesRecent=recent;
    const cut=Date.now()-86400000;
    const pts=recent.filter(p=>+(p.time||p.timestamp||0)>cut);
    const feeVal=(p)=>parseFloat(p.total||p.fees||p.amount||p.value||p.fee||p.usd||p.usdcVolume||p.totalFees||p.totalUsd||p.revenue||0);
    if(pts.length) D.fees24=pts.reduce((s,p)=>s+feeVal(p),0);
  }
  if(all){
    if(typeof all==='object'&&!Array.isArray(all)){
      if(all.totalFees||all.total||all.cumulative) D.feesAll=parseFloat(all.totalFees||all.total||all.cumulative||0)||null;
      if(all.totalBurned||all.burned) D.burned=parseFloat(all.totalBurned||all.burned);
    }
    if(Array.isArray(all)&&all.length) {
      const feeVal=(p)=>parseFloat(p.total||p.fees||p.amount||p.fee||p.usd||0);
      D.feesAll=all.reduce((s,p)=>s+feeVal(p),0);
    }
  }
}
async function fHolders() {
  const d=await hs('/holdersWithLimit/HYPE/20'); if(d?.addresses) D.holders=d.addresses;
}

// ‚îÄ‚îÄ‚îÄ NEW: GLOBAL PERP STATS FETCHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fPerpStats() {
  try {
    const d = await hl({type:'metaAndAssetCtxs'});
    if(Array.isArray(d)&&d.length>=2) {
      D.perpMeta = d[0]; // { universe: [...] }
      D.perpCtxs = d[1]; // array of asset contexts
      // Build enriched markets array
      const universe = D.perpMeta?.universe || [];
      let totalOI = 0, totalVol = 0;
      D.markets = universe.map((u,i) => {
        const ctx = D.perpCtxs[i] || {};
        const name = u.name || u.coin || ('Asset-'+i);
        const mid = parseFloat(ctx.midPx || ctx.markPx || D.allMids[name] || 0);
        const oi = parseFloat(ctx.openInterest || 0);
        const oiUsd = oi * mid;
        const vol = parseFloat(ctx.dayNtlVlm || 0);
        const funding = parseFloat(ctx.funding || 0);
        const premium = parseFloat(ctx.premium || 0);
        const prevPx = parseFloat(ctx.prevDayPx || 0);
        const chg = prevPx > 0 ? ((mid - prevPx) / prevPx * 100) : 0;
        totalOI += oiUsd;
        totalVol += vol;
        return { name, mid, oi, oiUsd, vol, funding, premium, chg, szDecimals: u.szDecimals };
      }).filter(m => m.mid > 0);
      D.totalOI = totalOI;
      D.totalPerpVol = totalVol;
      D.markets.sort((a,b) => b.oiUsd - a.oiUsd);
      console.log('[perp markets]', D.markets.length, 'total OI:', F.usd(totalOI));
    }
  } catch(e) { console.warn('fPerpStats', e); }
}

// ‚îÄ‚îÄ‚îÄ MASTER LOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAll() {
  const btn=document.getElementById('refreshBtn');
  btn.textContent='‚ü≥ ...'; btn.classList.add('busy');
  setStatus('FETCHING','yellow');
  await Promise.allSettled([fPrice(),fSpot(),fStaking(),fValidators(),fAfBal(),fAfOrders(),fDelegations(),fQueue(),fTransfers(),fFees(),fHolders(),fPerpStats()]);
  setStatus('LIVE','green');
  renderAll();
  if(document.getElementById('tab-charts').classList.contains('active')) {
    if(_priceChart && _priceCandleData.length) _drawPriceSeries();
    if(_burnChart) _drawBurnSeries();
  }
  btn.textContent='‚Üª REFRESH'; btn.classList.remove('busy');
}

function setStatus(t,c) {
  document.getElementById('liveText').textContent=t;
  const d=document.getElementById('liveDot');
  const col={green:'var(--green)',yellow:'var(--yellow)',red:'var(--red)'}[c]||'var(--text-dim)';
  d.style.background=col; d.style.boxShadow=`0 0 6px ${col}`;
}

const $=id=>document.getElementById(id);
const set=(id,v)=>{const e=$(id);if(e)e.textContent=v;};
const htm=(id,v)=>{const e=$(id);if(e)e.innerHTML=v;};

// ‚îÄ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getQAmt(e){return parseFloat(e.amount||e.hype||e.nHype||e.value||e.unstakeAmount||e.delegationAmount||e.size||e.qty||0);}
function renderAll() {
  const qt=D.queue.reduce((s,e)=>s+getQAmt(e),0);

  if(!D.staked && D.validators.length) {
    const tot=D.validators.reduce((s,v)=>s+parseFloat(v.stake||v.totalStake||v.stakedAmount||v.amount||0),0);
    if(tot>0) D.staked=tot;
  }

  if(D.price){ set('topPrice','$'+F.f2(D.price)); set('sbPrice','$'+F.f2(D.price)); }
  if(D.priceChg!=null){ const el=$('topChg'); el.textContent=F.pct(D.priceChg); el.className='price-chg '+(D.priceChg>=0?'up':'down'); }
  if(D.staked) set('tsStaked',F.c(D.staked));
  if(D.burned) set('tsBurned',F.c(D.burned));
  if(qt>0)     set('tsQueue',F.c(qt));
  if(D.fees24) set('tsFees',F.usd(D.fees24));
  if(D.price&&D.circSupply) set('tsMcap',F.usd(D.price*D.circSupply));
  set('tsUpdated',new Date().toLocaleTimeString());

  if(D.circSupply||D.burned) set('sbCirc',F.c(D.circSupply||(MAX_S-(D.burned||0))));
  if(D.burned){ set('sbBurned',F.c(D.burned)+' HYPE'); set('sbBurnPct',((D.burned/MAX_S)*100).toFixed(3)+'%'); }
  if(D.staked){ set('sbStaked',F.c(D.staked)+' HYPE'); set('sbStakedPct',((D.staked/MAX_S)*100).toFixed(1)+'%'); }
  if(qt>0) set('sbQTotal',F.c(qt)+' HYPE'); set('sbQCount',D.queue.length||'‚Äî');
  if(D.apr!=null) set('sbApr',(D.apr*100).toFixed(2)+'%');
  set('sbVals',D.validators.filter(v=>v.isActive!==false).length||D.validators.length||'‚Äî');
  if(D.afBal!=null) set('sbAfBal',F.c(D.afBal)+' HYPE');
  else if(D.afUsdc!=null) set('sbAfBal',F.c(D.afUsdc)+' USDC');
  set('sbAfBids',D.afOrders.length||'‚Äî');
  if(D.fees24&&D.price) set('sbBurnRate',F.c(D.fees24/D.price)+'/day');
  if(D.vol24) set('sbVol',F.usd(D.vol24));
  if(D.price) set('sbFdv',F.usd(D.price*MAX_S));
  if(D.price&&D.circSupply) set('sbMcap',F.usd(D.price*D.circSupply));

  // Platform stats in sidebar
  if(D.totalOI) { set('sbTotalOI',F.usd(D.totalOI)); set('rsTotalOI',F.usd(D.totalOI)); }
  if(D.totalPerpVol) { set('sbPerpVol',F.usd(D.totalPerpVol)); set('rsPerpVol',F.usd(D.totalPerpVol)); }
  if(D.markets.length) set('rsMarkets',D.markets.length);
  // Top funding
  if(D.markets.length) {
    const topF = [...D.markets].sort((a,b)=>Math.abs(b.funding)-Math.abs(a.funding))[0];
    if(topF) set('rsTopFunding', topF.name+' '+(topF.funding*100).toFixed(4)+'%');
  }

  const sp=D.staked?(D.staked/MAX_S)*100:0;
  let bull=0,bear=0;
  if(sp>35)bull++; if(sp<15)bear++;
  if(qt<50000)bull++; if(qt>500000)bear++;
  if(D.afOrders.length>0)bull++;
  if(D.priceChg>3)bull++; if(D.priceChg<-5)bear++;
  const sig=bull>bear?'BULLISH':bear>bull?'BEARISH':'NEUTRAL';
  const sigCol={BULLISH:'var(--green)',BEARISH:'var(--red)',NEUTRAL:'var(--yellow)'}[sig];
  htm('signalBox',`<div class="sig-box" style="background:${sigCol}18;border:1px solid ${sigCol}30"><div class="sig-lbl" style="color:${sigCol}">${sig}</div><div class="sig-sub">Staked:${sp.toFixed(1)}% ¬∑ Q:${F.c(qt)} ¬∑ Bids:${D.afOrders.length}</div></div>`);

  if(D.staked){ set('kStaked',F.c(D.staked)); set('kStakedS',((D.staked/MAX_S)*100).toFixed(1)+'% of total supply locked'); }
  if(D.burned){ set('kBurned',F.c(D.burned)); set('kBurnedS',((D.burned/MAX_S)*100).toFixed(3)+'% permanently removed'); }
  if(qt){ set('kQueue',F.c(qt)); set('kQueueS',D.queue.length+' wallets'+(D.price?' ¬∑ '+F.usd(qt*D.price):'')); }

  set('kuTotal',qt?F.c(qt):'‚Äî'); if(qt) set('kuTotalS',D.queue.length+' wallets'+(D.price?' ¬∑ '+F.usd(qt*D.price):''));
  const soon=D.queue.filter(e=>{const u=+(e.unlockTime||e.unlock_time||e.completionTime||0);return u>Date.now()&&u<Date.now()+86400000;}).reduce((s,e)=>s+parseFloat(e.amount||e.hype||e.nHype||e.value||0),0);
  set('kuSoon',soon>0?F.c(soon):'0');
  if(D.queue.length&&qt) set('kuAvg',F.c(qt/D.queue.length));

  const lines=[];
  if(sp>0){const e=sp>40?'üü¢':sp>20?'üü°':'üî¥';lines.push(`${e} <strong>${sp.toFixed(1)}%</strong> of supply staked. ${sp>35?'High conviction ‚Äî limited near-term float.':'Moderate lockup level.'}`)}
  if(qt>0&&D.price){const e=qt>500000?'üî¥':qt>100000?'üü°':'üü¢';lines.push(`${e} <strong>${F.c(qt)} HYPE</strong> (~${F.usd(qt*D.price)}) in unstake queue ‚Äî potential sell pressure within 8 days.`)}
  if(D.fees24&&D.price) lines.push(`üî• Today's fees (~${F.usd(D.fees24)}) imply <strong>${F.c(D.fees24/D.price)} HYPE</strong> burned at current prices.`);
  if(D.afOrders.length){const tot=D.afOrders.reduce((s,o)=>s+parseFloat(o.sz||0),0);const avg=D.afOrders.reduce((s,o)=>s+parseFloat(o.limitPx||o.px||0),0)/D.afOrders.length;lines.push(`üì° AF has <strong>${D.afOrders.length} open buy bid${D.afOrders.length>1?'s':''}</strong> (~${F.c(tot)} HYPE, avg $${F.f2(avg)}) ‚Äî protocol backstop active.`)}
  if(D.priceChg!=null) lines.push(`${D.priceChg>=0?'‚Üë':'‚Üì'} Price <strong>${F.pct(D.priceChg)}</strong> in 24h @ $${F.f2(D.price)}.`);
  if(D.totalPerpVol) lines.push(`üìä Platform 24h perp volume: <strong>${F.usd(D.totalPerpVol)}</strong> across ${D.markets.length} markets.`);
  if(!lines.length) lines.push('Fetching live data from Hyperliquid API + HypurrScan...');
  htm('insightBody',lines.join('<br><br>'));

  const alerts=[];
  if(qt>1000000) alerts.push({i:'üö®',t:`Massive queue: ${F.c(qt)} HYPE (~${F.usd(qt*(D.price||0))}) ‚Äî high sell pressure within 8 days`});
  else if(qt>200000) alerts.push({i:'‚ö†Ô∏è',t:`${F.c(qt)} HYPE queued to unstake ‚Äî moderate sell pressure expected`});
  else if(qt>0) alerts.push({i:'‚ÑπÔ∏è',t:`${F.c(qt)} HYPE in unstake queue ‚Äî manageable pressure`});
  if(D.afOrders.length) alerts.push({i:'üõ°Ô∏è',t:`AF has ${D.afOrders.length} active HYPE buy bid${D.afOrders.length>1?'s':''} ‚Äî protocol support active`});
  if(D.fees24>2e6) alerts.push({i:'üî•',t:`High fee day: ${F.usd(D.fees24)} in 24h`});
  else if(D.fees24) alerts.push({i:'üí∞',t:`24h fees: ${F.usd(D.fees24)} ‚Üí AF ‚Üí HYPE burns`});
  if(D.priceChg!=null&&D.priceChg<-8) alerts.push({i:'üìâ',t:`Price down ${F.pct(D.priceChg)} ‚Äî watch AF bids + staking`});
  // Funding alerts
  if(D.markets.length) {
    const extreme = D.markets.filter(m=>Math.abs(m.funding)>0.001).sort((a,b)=>Math.abs(b.funding)-Math.abs(a.funding))[0];
    if(extreme) alerts.push({i:'üìà',t:`${extreme.name} funding ${(extreme.funding*100).toFixed(3)}% ‚Äî ${extreme.funding>0?'longs paying shorts':'shorts paying longs'}`});
  }
  if(!alerts.length) alerts.push({i:'‚úÖ',t:'No critical alerts. Monitoring all feeds.'});
  htm('alertsPanel',alerts.map(a=>`<div class="alert-row"><span class="alert-ico">${a.i}</span><span>${a.t}</span></div>`).join(''));

  renderOverviewFeed();
  renderQueueList(qt);
  renderStakingFlows();
  renderAF();
  renderFees();
  renderValidators();
  renderHolders();
  renderFeeSparkline();
  renderUnstakingHistogram();
  drawFeeCanvasChart();
  drawValDonut();
  renderGlobalStats();
  renderMarketExplorer();

  setTimeout(()=>{
    const feeVal=(p)=>parseFloat(p.total||p.fees||p.amount||p.value||p.fee||p.usd||p.usdcVolume||p.totalFees||0);
    const fv=D.feesRecent.map(feeVal).filter(v=>v>0);
    if(fv.length>=2){drawSparkline('sparkBurned',fv,'rgba(255,94,26,0.9)','#ff5e1a');}
    if(D.staked){drawSparkline('sparkStaked',[D.staked*0.97,D.staked*0.99,D.staked],'rgba(0,212,255,0.9)','#00d4ff');}
    if(qt>0){const q=D.queue.map((_,i)=>qt-(i*qt/D.queue.length*0.1));drawSparkline('sparkQueue',q.slice(0,10),'rgba(255,61,80,0.9)','#ff3d50');}
  },100);
  set('tbUQ',D.queue.length||'0');
}

// ‚îÄ‚îÄ‚îÄ EXISTING RENDER FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOverviewFeed() {
  const all=[...D.delegations.slice(0,10).map(e=>({...e,_t:'delegation'})),...D.transfers.slice(0,10).map(e=>({...e,_t:'transfer'}))].sort((a,b)=>+(b.time||b.timestamp||0)-(+(a.time||a.timestamp||0))).slice(0,20);
  htm('overviewFeed',all.length?all.map(e=>feedRow(e)).join(''):es('No events yet','Will populate from /delegations + /aLotOfTransfers'));
}

function renderQueueList(qt) {
  if(!D.queue.length){ htm('queueList',`<div class="es">Queue data from /fullUnstakingQueue<br><a href="https://hypurrscan.io/staking" target="_blank">View on HypurrScan ‚Üó</a></div>`); return; }
  const sorted=[...D.queue].sort((a,b)=>getQAmt(b)-getQAmt(a));
  htm('queueList',`<div style="padding:7px 13px;background:var(--red-dim);border-bottom:1px solid rgba(255,61,80,.15);display:flex;justify-content:space-between;font-size:10px"><span style="color:var(--red)">‚ö† ${sorted.length} wallets ¬∑ ${F.c(qt)} HYPE${D.price?' (~'+F.usd(qt*D.price)+')':''}</span><span style="color:var(--text-dim)">8-day unlock window</span></div>`+
    sorted.map(e=>{
      const amt=getQAmt(e);
      const addr=e.user||e.address||e.delegator||e.wallet||e.account;
      const unlockTs=e.unlockTime||e.unlock_time||e.completionTime||e.finishTime||e.unlockAt;
      const cd=unlockTs?F.cd(unlockTs):{txt:'Unknown',urgent:false,pct:50};
      const val=e.validator||e.validatorAddress||e.validatorAddr||e.from||e.dest||'';
      const valInfo=val?D.validators.find(v=>(v.validator||v.address||'').toLowerCase()===val.toLowerCase()):null;
      const valName=valInfo?(valInfo.name||valInfo.moniker||F.addr(val)):val?F.addr(val):'‚Äî';
      return `<div class="qi"><div><div class="qi-addr" onclick="openAddr('${addr}')">${F.addr(addr)}</div><div class="qi-sub">Validator: <span style="color:var(--text-dim)">${valName}</span></div><div class="prog"><div class="prog-fill" style="width:${cd.pct||0}%"></div></div></div><div><div class="qi-amt">‚àí${amt>0?F.c(amt):'?'} HYPE</div><div class="qi-usd">${D.price&&amt?F.usd(amt*D.price):'‚Äî'}</div></div><div><div class="qi-cd" style="color:${cd.urgent?'var(--red)':'var(--text-dim)'}">${cd.txt}</div><div class="qi-pct">${qt>0&&amt?(amt/qt*100).toFixed(1)+'% of Q':'‚Äî'}</div></div></div>`;
    }).join(''));
}

function renderStakingFlows() {
  const stakes=D.delegations.filter(e=>isStake(e));
  const unstakes=D.delegations.filter(e=>isUnstake(e));
  const whales=[...D.delegations].filter(e=>getQAmt(e)>=10000).sort((a,b)=>getQAmt(b)-getQAmt(a));
  htm('stakeFeed',stakes.length?stakes.slice(0,15).map(e=>feedRow(e,'stake')).join(''):es('No delegation events yet','/delegations'));
  htm('unstakeFeed',unstakes.length?unstakes.slice(0,15).map(e=>feedRow(e,'unstake')).join(''):es('No undelegation events yet','/delegations'));
  htm('whaleFeed',whales.length?whales.slice(0,10).map(e=>feedRow(e,isUnstake(e)?'unstake':'stake')).join(''):`<div class="es">No whale movements (‚â•10K HYPE) in current data.</div>`);
  setTimeout(drawValDonut,50);
}

function isStake(e){const t=(e.action?.type||e.type||e.actionType||'').toLowerCase();return(t.includes('cdelegate')||t.includes('delegate'))&&!t.includes('undelegate')&&!t.includes('undelegat');}
function isUnstake(e){const t=(e.action?.type||e.type||e.actionType||'').toLowerCase();return t.includes('undelegate')||t.includes('undelegat');}

function renderAF() {
  const afTxs=D.transfers.filter(t=>{const f=(t.user||t.from||'').toLowerCase(),to=(t.to||'').toLowerCase();return f===AF||to===AF;});
  const burns=D.transfers.filter(t=>{const to=(t.to||'').toLowerCase(),tp=(t.action?.type||t.type||'').toLowerCase();return to===BURN||tp.includes('burn');});
  htm('afTxFeed',afTxs.length?afTxs.slice(0,15).map(e=>feedRow(e,detectAFType(e))).join(''):`<div class="es">AF transfers from /aLotOfTransfers<br><a href="https://hypurrscan.io/address/${AF}" target="_blank">View on HypurrScan ‚Üó</a></div>`);
  htm('burnFeed',burns.length?burns.slice(0,10).map(e=>feedRow(e,'burn')).join(''):`<div class="es">Burn events from /transfers feed<br><a href="https://www.hypeburn.fun/" target="_blank">View on HypeBurn ‚Üó</a></div>`);
  htm('afBidsFeed',D.afOrders.length?D.afOrders.map(o=>`<div class="fi"><div class="fi-t"><span class="bdg by">BID</span><br>${F.t(o.timestamp||o.time)}</div><div class="fi-d">Buy <strong style="color:var(--yellow)">${F.c(o.sz||0)}</strong> HYPE @ <strong style="color:var(--yellow)">$${F.f2(o.limitPx||o.px||0)}</strong></div><div class="fi-amt" style="color:var(--yellow)">${F.usd((o.sz||0)*(D.price||0))}</div></div>`).join(''):`<div class="es">No open AF buy bids detected.<br>AF typically maintains resting orders on HYPE/USDC book.</div>`);
}

function detectAFType(t){const tp=(t.action?.type||t.type||'').toLowerCase();if(tp.includes('burn'))return'burn';if(parseFloat(t.hype||t.amount||0)>0)return'buy';return'transfer';}

function renderFees() {
  if(D.feesAll) set('kFeeAll',F.usd(D.feesAll));
  if(D.fees24){ set('kFee24',F.usd(D.fees24)); set('feeMetaLabel',F.usd(D.fees24)); }
  if(D.fees24&&D.price) set('kFeeRate',F.c(D.fees24/D.price)+' HYPE/day');
  const recent24=[...D.feesRecent].filter(p=>+(p.time||p.timestamp||0)>Date.now()-86400000).sort((a,b)=>+(a.time||a.timestamp||0)-(+(b.time||b.timestamp||0)));
  renderFeeBarChart('feeChart24h',recent24.slice(-12),'h');
  const all48=[...D.feesRecent].sort((a,b)=>+(a.time||a.timestamp||0)-(+(b.time||b.timestamp||0)));
  renderFeeBarChart('feeChart48h',all48.slice(-20),'full');
  drawFeeCanvasChart();
}

function renderFeeBarChart(id,pts,labelMode) {
  if(!pts.length){ htm(id,`<div class="es">Fee data from /feesRecent</div>`); return; }
  const feeVal=(p)=>parseFloat(p.total||p.fees||p.amount||p.value||p.fee||p.usd||p.usdcVolume||p.totalFees||0);
  const max=Math.max(...pts.map(feeVal));
  if(!max){ htm(id,`<div class="es">Fee amounts: ${JSON.stringify(Object.keys(pts[0]||{}))}</div>`); return; }
  htm(id,pts.map(p=>{
    const v=feeVal(p);
    const w=max>0?(v/max*100).toFixed(1):'0';
    const ts=+(p.time||p.timestamp||0);
    const lbl=labelMode==='h'?new Date(ts).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false}):new Date(ts).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',hour12:false});
    return `<div class="fbrow"><div class="fblabel" style="width:${labelMode==='h'?38:70}px;font-size:9px">${lbl}</div><div class="fbout"><div class="fbin" style="width:${w}%"></div><div class="fbval">${F.usd(v)}</div></div></div>`;
  }).join(''));
}

function renderValidators() {
  if(!D.validators.length){ htm('valRows',`<tr><td colspan="6">${es('Loading validators...','Hyperliquid validatorSummaries API')}</td></tr>`); return; }
  const stakeOf=v=>parseFloat(v.stake||v.totalStake||v.stakedAmount||v.amount||0);
  const total=D.validators.reduce((s,v)=>s+stakeOf(v),0);
  htm('valRows',D.validators.slice(0,25).map(v=>{
    const stk=stakeOf(v);
    const pct=total>0?(stk/total*100).toFixed(1):'0.0';
    const comm=v.commission!=null?(parseFloat(v.commission)*100).toFixed(0)+'%':'‚Äî';
    const ok=v.isActive!==false&&v.jailed!==true&&v.status!=='jailed';
    const name=(v.name||v.moniker||F.addr(v.validator||v.address||''));
    const apr=D.apr!=null?((D.apr*(1-parseFloat(v.commission||0)))*100).toFixed(1)+'%':'‚Äî';
    const dc=ok?'var(--green)':'var(--red)';
    return `<tr><td><div class="vname"><div class="vdot" style="background:${dc};box-shadow:0 0 4px ${dc}"></div>${name.length>22?name.slice(0,20)+'‚Ä¶':name}</div></td><td>${F.c(stk)}</td><td><div class="vbcell"><div class="vbar"><div class="vbar-fill" style="width:${Math.min(100,parseFloat(pct)*2.5).toFixed(0)}%"></div></div>${pct}%</div></td><td>${comm}</td><td style="color:var(--green)">${apr}</td><td><span class="bdg ${ok?'bk':'bu'}">${ok?'ACTIVE':'JAILED'}</span></td></tr>`;
  }).join(''));
}

function renderHolders() {
  const entries=Object.entries(D.holders).sort((a,b)=>b[1]-a[1]);
  if(!entries.length){ htm('topHolders',`<div class="es">Loading... (holdersWithLimit/HYPE/20)</div>`); return; }
  htm('topHolders',entries.slice(0,10).map(([addr,bal],i)=>`<div class="holder-row"><span class="h-rank">${i+1}</span><span class="h-addr" onclick="openAddr('${addr}')" title="${addr}">${F.addr(addr)}</span><span class="h-amt">${F.c(bal)}</span></div>`).join(''));
}

function renderFeeSparkline() {
  const cv=$('feeSparkline'); if(!cv)return;
  const ctx=cv.getContext('2d'); ctx.clearRect(0,0,224,56);
  const pts=[...D.feesRecent].sort((a,b)=>+(a.time||a.timestamp||0)-(+(b.time||b.timestamp||0)));
  if(pts.length<2)return;
  const vals=pts.map(p=>parseFloat(p.total||p.fees||p.amount||0));
  const max=Math.max(...vals),min=Math.min(...vals),range=max-min||1;
  const W=224,H=56,P=3;
  const step=(W-P*2)/(vals.length-1);
  const grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,'rgba(255,94,26,.4)'); grad.addColorStop(1,'rgba(255,94,26,.02)');
  ctx.beginPath();
  vals.forEach((v,i)=>{const x=P+i*step,y=H-P-((v-min)/range)*(H-P*2);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  const lx=P+(vals.length-1)*step; ctx.lineTo(lx,H); ctx.lineTo(P,H); ctx.closePath();
  ctx.fillStyle=grad; ctx.fill();
  ctx.beginPath();
  vals.forEach((v,i)=>{const x=P+i*step,y=H-P-((v-min)/range)*(H-P*2);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.strokeStyle='rgba(255,94,26,.9)'; ctx.lineWidth=1.5; ctx.stroke();
}

function feedRow(e,forceType) {
  const ts=e.time||e.timestamp||e.createdAt||e.blockTime;
  const addr=e.user||e.address||e.from||e.delegator||e.wallet||e.sender;
  const valRaw=e.validator||e.validatorAddress||e.validatorAddr||e.to||e.action?.validator||e.action?.validatorAddress||e.dest||'';
  const valInfo=valRaw?D.validators.find(v=>(v.validator||v.address||'').toLowerCase()===(valRaw||'').toLowerCase()):null;
  const to=valInfo?(valInfo.name||valInfo.moniker||F.addr(valRaw)):valRaw?F.addr(valRaw):'‚Äî';
  const amt=getQAmt(e)||parseFloat(e.sz||0);
  const at=(e.action?.type||e.type||e.actionType||'').toLowerCase();
  let type=forceType;
  if(!type){
    if((at.includes('cdelegate')||at.includes('delegate'))&&!at.includes('undelegate')) type='stake';
    else if(at.includes('undelegate')||at.includes('undelegat')) type='unstake';
    else if(at.includes('burn')||(valRaw||'').toLowerCase()===BURN) type='burn';
    else if((addr||'').toLowerCase()===AF||(valRaw||'').toLowerCase()===AF) type=amt>0?'buy':'transfer';
    else type='transfer';
  }
  const bdgMap={stake:'<span class="bdg bk">STAKE</span>',unstake:'<span class="bdg bu">UNSTAKE</span>',burn:'<span class="bdg bb">BURN</span>',buy:'<span class="bdg bg">BUY</span>',bid:'<span class="bdg by">BID</span>',transfer:'<span class="bdg bt">TX</span>'};
  const aclr={stake:'var(--accent)',unstake:'var(--red)',burn:'var(--accent2)',buy:'var(--green)',bid:'var(--yellow)',transfer:'var(--text-dim)'}[type]||'var(--text)';
  let desc='';
  if(type==='stake') desc=`<span class="fi-a" onclick="openAddr('${addr}')">${F.addr(addr)}</span> delegated to <span style="color:var(--text)">${to}</span>`;
  else if(type==='unstake') desc=`<span class="fi-a" onclick="openAddr('${addr}')">${F.addr(addr)}</span> undelegated from <span style="color:var(--text)">${to}</span>`;
  else if(type==='burn') desc=`HYPE permanently burned to <span style="color:var(--accent2)">${F.addr(BURN)}</span>`;
  else if(type==='buy') desc=`AF bought HYPE${e.px||e.price?' @ <strong style="color:var(--green)">$'+(e.px||e.price)+'</strong>':''}`;
  else desc=`<span class="fi-a" onclick="openAddr('${addr}')">${F.addr(addr)}</span> ‚Üí <span class="fi-a" onclick="openAddr('${valRaw}')">${to}</span>`;
  return `<div class="fi"><div class="fi-t">${bdgMap[type]||''}<br>${ts?F.t(ts):'‚Äî'}<br><span style="font-size:9px">${ts?F.ago(ts)+' ago':''}</span></div><div class="fi-d">${desc}${at?`<br><span style="font-size:9px;color:var(--text-dim)">${at}</span>`:''}</div><div class="fi-amt" style="color:${aclr}">${amt>0?F.c(amt)+' HYPE':'‚Äî'}${amt>0&&D.price?`<br><span class="fi-usd">${F.usd(amt*D.price)}</span>`:''}</div></div>`;
}

function es(msg,src){return`<div class="es">${msg}<br><span style="font-size:9px;color:var(--text-dim)">${src||''}</span></div>`;}
function openAddr(a){if(!a||a==='undefined')return;window.open('https://hypurrscan.io/address/'+a,'_blank');}

// ‚îÄ‚îÄ‚îÄ SPARKLINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawSparkline(canvasId, values, color, fill) {
  const cv=document.getElementById(canvasId); if(!cv||values.length<2)return;
  const W=cv.parentElement.clientWidth||200, H=32;
  cv.width=W; cv.height=H;
  const ctx=cv.getContext('2d');
  ctx.clearRect(0,0,W,H);
  const max=Math.max(...values), min=Math.min(...values), range=max-min||1;
  const P=2, step=(W-P*2)/(values.length-1);
  if(fill) {
    const grad=ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0,fill+'44'); grad.addColorStop(1,fill+'08');
    ctx.beginPath();
    values.forEach((v,i)=>{const x=P+i*step,y=H-P-((v-min)/range)*(H-P*2);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
    ctx.lineTo(P+(values.length-1)*step,H); ctx.lineTo(P,H); ctx.closePath();
    ctx.fillStyle=grad; ctx.fill();
  }
  ctx.beginPath();
  values.forEach((v,i)=>{const x=P+i*step,y=H-P-((v-min)/range)*(H-P*2);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.strokeStyle=color; ctx.lineWidth=1.5; ctx.stroke();
  const lx=P+(values.length-1)*step, ly=H-P-((values[values.length-1]-min)/range)*(H-P*2);
  ctx.beginPath(); ctx.arc(lx,ly,2.5,0,Math.PI*2);
  ctx.fillStyle=color; ctx.fill();
}

// ‚îÄ‚îÄ‚îÄ FEE CANVAS CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawFeeCanvasChart() {
  const cv=document.getElementById('feeChartCanvas'); if(!cv)return;
  const wrap=cv.parentElement;
  const W=wrap.clientWidth-16, H=160;
  cv.width=W; cv.height=H;
  const ctx=cv.getContext('2d');
  ctx.clearRect(0,0,W,H);
  const sorted=[...D.feesRecent].sort((a,b)=>+(a.time||a.timestamp||0)-(+(b.time||b.timestamp||0)));
  const feeVal=(p)=>parseFloat(p.total||p.fees||p.amount||p.value||p.fee||p.usd||p.usdcVolume||p.totalFees||0);
  const pts=sorted.slice(-48);
  if(pts.length<2){ctx.fillStyle='#4a6678';ctx.font='11px IBM Plex Mono,monospace';ctx.textAlign='center';ctx.fillText('Fee data loading...',W/2,H/2);return;}
  const vals=pts.map(feeVal);
  const max=Math.max(...vals)||1;
  const P=30, PB=20, barW=Math.max(3,(W-P-10)/pts.length-1);
  const barArea=H-P-PB;
  ctx.strokeStyle='rgba(26,36,48,0.8)'; ctx.lineWidth=1;
  [0.25,0.5,0.75,1].forEach(f=>{
    const y=P+barArea*(1-f);
    ctx.beginPath(); ctx.moveTo(P,y); ctx.lineTo(W,y); ctx.stroke();
    ctx.fillStyle='#4a6678'; ctx.font='8px IBM Plex Mono,monospace'; ctx.textAlign='right';
    ctx.fillText('$'+F.c(max*f),P-3,y+3);
  });
  pts.forEach((p,i)=>{
    const v=feeVal(p);
    const bh=Math.max(1,(v/max)*barArea);
    const x=P+i*(barW+1);
    const y=P+barArea-bh;
    const grad=ctx.createLinearGradient(0,y,0,y+bh);
    grad.addColorStop(0,'rgba(187,134,252,0.9)'); grad.addColorStop(1,'rgba(187,134,252,0.2)');
    ctx.fillStyle=grad;
    ctx.fillRect(x,y,barW,bh);
    if(i%8===0||(i===pts.length-1)){
      const ts=+(p.time||p.timestamp||0);
      ctx.fillStyle='#4a6678'; ctx.font='8px IBM Plex Mono,monospace'; ctx.textAlign='center';
      ctx.fillText(ts?new Date(ts).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',hour12:false}):'‚Äî',x+barW/2,H-4);
    }
  });
  const last=vals[vals.length-1];
  ctx.fillStyle='rgba(187,134,252,0.9)'; ctx.font='bold 10px IBM Plex Mono,monospace'; ctx.textAlign='left';
  ctx.fillText('Latest: $'+F.f2(last), P, P-6);
}

// ‚îÄ‚îÄ‚îÄ VALIDATOR DONUT CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DONUT_COLORS=['#00d4ff','#ff5e1a','#00e676','#ffcc44','#bb86fc','#ff3d50','#4dd9ff','#ff9a3c','#69ff9e','#ffe066'];
function drawValDonut() {
  const cv=document.getElementById('valDonut'); if(!cv||!D.validators.length)return;
  const ctx=cv.getContext('2d');
  const W=120, H=120, R=50, r=28;
  ctx.clearRect(0,0,W,H);
  const valsWithStake=D.validators.filter(v=>parseFloat(v.stake||v.totalStake||v.stakedAmount||0)>0);
  const total=valsWithStake.reduce((s,v)=>s+parseFloat(v.stake||v.totalStake||v.stakedAmount||0),0);
  if(!total)return;
  const top=valsWithStake.slice(0,9);
  const otherStake=valsWithStake.slice(9).reduce((s,v)=>s+parseFloat(v.stake||v.totalStake||v.stakedAmount||0),0);
  const slices=[...top.map((v,i)=>({name:v.name||v.moniker||F.addr(v.validator||v.address||''),stake:parseFloat(v.stake||v.totalStake||v.stakedAmount||0),color:DONUT_COLORS[i]}))];
  if(otherStake>0) slices.push({name:'Others',stake:otherStake,color:'#263545'});
  let startAngle=-Math.PI/2;
  slices.forEach(s=>{
    const angle=(s.stake/total)*Math.PI*2;
    ctx.beginPath(); ctx.moveTo(W/2,H/2); ctx.arc(W/2,H/2,R,startAngle,startAngle+angle); ctx.closePath();
    ctx.fillStyle=s.color; ctx.fill();
    startAngle+=angle;
  });
  ctx.beginPath(); ctx.arc(W/2,H/2,r,0,Math.PI*2); ctx.fillStyle='#060a0e'; ctx.fill();
  ctx.fillStyle='#b8ccd8'; ctx.font='bold 9px IBM Plex Mono,monospace'; ctx.textAlign='center';
  ctx.fillText(slices.length+' vals',W/2,H/2-2);
  ctx.fillStyle='#4a6678'; ctx.font='8px IBM Plex Mono,monospace';
  ctx.fillText(F.c(total),W/2,H/2+10);
  const leg=document.getElementById('valLegend'); if(!leg)return;
  leg.innerHTML=slices.slice(0,8).map(s=>`<div class="val-legend-row"><div class="val-legend-name"><div class="val-legend-dot" style="background:${s.color}"></div>${s.name.length>18?s.name.slice(0,16)+'‚Ä¶':s.name}</div><div class="val-legend-pct">${(s.stake/total*100).toFixed(1)}%</div></div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ UNSTAKING HISTOGRAM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderUnstakingHistogram() {
  if(!D.queue.length){ htm('unstakeHistogram',`<div class="es">Load unstaking data first</div>`); return; }
  const buckets=Array.from({length:9},(_,i)=>({label:i===0?'<24h':`Day ${i+1}`,hype:0,count:0}));
  const now=Date.now();
  D.queue.forEach(e=>{
    const amt=getQAmt(e);
    const unlockTs=+(e.unlockTime||e.unlock_time||e.completionTime||e.finishTime||e.unlockAt||0);
    const daysLeft=unlockTs>0?Math.floor((unlockTs-now)/86400000):4;
    const idx=Math.max(0,Math.min(8,daysLeft));
    buckets[idx].hype+=amt; buckets[idx].count++;
  });
  const maxHype=Math.max(...buckets.map(b=>b.hype))||1;
  const total=buckets.reduce((s,b)=>s+b.hype,0);
  htm('unstakeHistogram',buckets.map((b,i)=>{
    const w=(b.hype/maxHype*100).toFixed(1);
    const urgent=i===0;
    const color=urgent?'var(--red)':i<3?'var(--yellow)':'var(--accent)';
    return `<div class="uh-row"><div class="uh-lbl" style="color:${color}">${b.label}</div><div class="uh-bar"><div class="uh-fill" style="width:${w}%;background:${color}"></div><div class="uh-val">${b.hype>0?F.c(b.hype)+' HYPE ('+b.count+'w)':''}</div></div></div>`;
  }).join(''));
  set('unstakeHistMeta', `${D.queue.length} wallets ¬∑ ${F.c(total)} total HYPE queued`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW: GLOBAL STATS RENDERER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderGlobalStats() {
  if(!D.markets.length) return;

  set('gsVol24', F.usd(D.totalPerpVol));
  set('gsVol24S', D.markets.length + ' active markets');
  set('gsTotalOI', F.usd(D.totalOI));
  set('gsTotalOIS', 'Across ' + D.markets.length + ' perp pairs');
  set('gsMarkets', D.markets.length);

  // Top markets by OI
  const topOI = D.markets.slice(0, 15);
  const maxOI = topOI[0]?.oiUsd || 1;
  htm('gsTopOIList', topOI.map(m => {
    const w = (m.oiUsd / maxOI * 100).toFixed(1);
    const fundClr = m.funding >= 0 ? 'var(--green)' : 'var(--red)';
    return `<div class="fbrow" style="padding:4px 13px"><div class="fblabel" style="width:70px;font-size:10px;color:var(--text-bright);font-weight:500">${m.name}</div><div class="fbout" style="height:18px"><div class="fbin" style="width:${w}%;background:linear-gradient(90deg,var(--accent) 0%,rgba(0,212,255,.3) 100%)"></div><div class="fbval">${F.usd(m.oiUsd)} ¬∑ <span style="color:${fundClr}">${(m.funding*100).toFixed(4)}%</span></div></div></div>`;
  }).join(''));
  set('gsTopOIMeta', `Top ${topOI.length} markets by open interest`);

  // Top markets by volume
  const topVol = [...D.markets].sort((a,b) => b.vol - a.vol).slice(0, 10);
  const maxVol = topVol[0]?.vol || 1;
  htm('gsTopVolList', topVol.map(m => {
    const w = (m.vol / maxVol * 100).toFixed(1);
    return `<div class="fbrow" style="padding:4px 13px"><div class="fblabel" style="width:70px;font-size:10px;color:var(--text-bright);font-weight:500">${m.name}</div><div class="fbout" style="height:18px"><div class="fbin" style="width:${w}%;background:linear-gradient(90deg,var(--green) 0%,rgba(0,230,118,.3) 100%)"></div><div class="fbval">${F.usd(m.vol)}</div></div></div>`;
  }).join(''));

  // Funding snapshot
  const fundingSorted = [...D.markets].filter(m => m.funding !== 0).sort((a,b) => Math.abs(b.funding) - Math.abs(a.funding)).slice(0, 12);
  htm('gsFundingList', fundingSorted.map(m => {
    const pct = (m.funding * 100).toFixed(4);
    const clr = m.funding >= 0 ? 'var(--green)' : 'var(--red)';
    const dir = m.funding >= 0 ? 'Longs ‚Üí Shorts' : 'Shorts ‚Üí Longs';
    const annual = (m.funding * 100 * 3 * 365).toFixed(1);
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 13px;border-bottom:1px solid rgba(26,36,48,.5);font-size:10px"><span style="color:var(--text-bright);font-weight:500;width:70px">${m.name}</span><span style="color:${clr};font-weight:700;font-variant-numeric:tabular-nums">${pct}%</span><span style="color:var(--text-dim);font-size:9px">${dir}</span><span style="color:var(--text-dim);font-size:9px">${annual}% APR</span></div>`;
  }).join(''));

  // Summary insight
  const topByFunding = fundingSorted[0];
  const summaryLines = [];
  summaryLines.push(`Platform is running <strong>${D.markets.length} perpetual markets</strong> with <strong>${F.usd(D.totalOI)}</strong> total open interest.`);
  summaryLines.push(`24h trading volume: <strong>${F.usd(D.totalPerpVol)}</strong>.`);
  if(topByFunding) {
    const fDir = topByFunding.funding > 0 ? 'positive' : 'negative';
    summaryLines.push(`Most extreme funding: <strong>${topByFunding.name}</strong> at <strong>${(topByFunding.funding*100).toFixed(4)}%</strong> (${fDir}) ‚Äî ${topByFunding.funding > 0 ? 'overcrowded longs, mean-reversion risk' : 'crowded shorts, squeeze potential'}.`);
  }
  if(D.fees24 && D.totalPerpVol) {
    const feeRate = (D.fees24 / D.totalPerpVol * 100).toFixed(4);
    summaryLines.push(`Effective fee rate: ~${feeRate}% of volume ‚Üí all flows to HYPE buyback + burn.`);
  }
  htm('gsSummary', summaryLines.join('<br><br>'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW: MARKET EXPLORER RENDERER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMarketExplorer() {
  if(!D.markets.length) return;
  const container = $('mktExplorer');
  const hdr = `<div class="mkt-row hdr"><div>Market</div><div style="text-align:right">Price</div><div style="text-align:right">24h Chg</div><div style="text-align:right">Open Interest</div><div style="text-align:right">24h Volume</div><div style="text-align:right">Funding (8h)</div><div style="text-align:right">Premium</div></div>`;

  const rows = D.markets.slice(0, 50).map(m => {
    const chgClr = m.chg >= 0 ? 'var(--green)' : 'var(--red)';
    const fundClr = m.funding >= 0 ? 'pos' : 'neg';
    return `<div class="mkt-row" onclick="showMktDetail('${m.name}')" style="cursor:pointer">
      <div class="mkt-coin">${m.name}</div>
      <div style="text-align:right;color:var(--text-bright)">$${m.mid < 1 ? F.f4(m.mid) : F.f2(m.mid)}</div>
      <div style="text-align:right;color:${chgClr}">${F.pct(m.chg)}</div>
      <div style="text-align:right">${F.usd(m.oiUsd)}</div>
      <div style="text-align:right">${F.usd(m.vol)}</div>
      <div style="text-align:right" class="mkt-funding ${fundClr}">${(m.funding*100).toFixed(4)}%</div>
      <div style="text-align:right;color:var(--text-dim)">${(m.premium*100).toFixed(4)}%</div>
    </div>`;
  }).join('');

  container.innerHTML = hdr + rows;
}

let _mktDetailChart = null;
async function showMktDetail(coin) {
  const m = D.markets.find(x => x.name === coin);
  if(!m) return;
  const panel = $('mktDetailPanel');
  panel.style.display = 'block';
  set('mktDetailTitle', coin + ' / USD ‚Äî Detail');
  set('mdOI', F.usd(m.oiUsd));
  set('mdVol', F.usd(m.vol));
  set('mdFunding', (m.funding*100).toFixed(4) + '%');

  // ‚îÄ‚îÄ Price candlestick chart ‚îÄ‚îÄ
  const wrap = $('mktDetailChartWrap');
  if(_mktDetailChart) { try{_mktDetailChart.remove();}catch(e){} _mktDetailChart=null; }
  wrap.innerHTML = '';
  const {w,h} = {w: Math.max(wrap.clientWidth, 200), h: wrap.clientHeight || 220};

  try {
    const endTime = Date.now(), startTime = endTime - 7*86400000;
    const candles = await hl({type:'candleSnapshot', req:{coin, interval:'1h', startTime, endTime}});
    if(Array.isArray(candles) && candles.length > 2) {
      _mktDetailChart = LightweightCharts.createChart(wrap, _lcBase({width:w, height:h}));
      const series = _mktDetailChart.addCandlestickSeries({
        upColor:'#00e676', downColor:'#ff3d50',
        borderUpColor:'#00e676', borderDownColor:'#ff3d50',
        wickUpColor:'rgba(0,230,118,0.7)', wickDownColor:'rgba(255,61,80,0.7)',
      });
      series.setData(candles.map(c=>({time:Math.floor(c.t/1000),open:+c.o,high:+c.h,low:+c.l,close:+c.c})).sort((a,b)=>a.time-b.time));
      _mktDetailChart.timeScale().fitContent();
    }
  } catch(e) { wrap.innerHTML = '<div class="es">Could not load chart for '+coin+'</div>'; }

  // ‚îÄ‚îÄ Funding Rate History (7 days) ‚îÄ‚îÄ
  _loadFundingHistory(coin);

  // ‚îÄ‚îÄ L2 Order Book Depth ‚îÄ‚îÄ
  _loadL2Book(coin);
}

// Funding History Chart ‚Äî uses fundingHistory endpoint
let _fundingChart = null;
async function _loadFundingHistory(coin) {
  const wrap = $('mdFundingChartWrap');
  if(!wrap) return;
  if(_fundingChart) { try{_fundingChart.remove();}catch(e){} _fundingChart=null; }
  wrap.innerHTML = '<div class="es">Loading funding history...</div>';

  try {
    const endTime = Date.now(), startTime = endTime - 7*86400000;
    const data = await hl({type:'fundingHistory', coin, startTime});
    if(!Array.isArray(data) || data.length < 2) {
      wrap.innerHTML = '<div class="es">Insufficient funding data for '+coin+'</div>';
      return;
    }

    wrap.innerHTML = '';
    const {w: cw} = {w: Math.max(wrap.clientWidth, 200)};
    _fundingChart = LightweightCharts.createChart(wrap, _lcBase({width: cw, height: 180}));

    // Histogram series ‚Äî green for positive, red for negative
    const histSeries = _fundingChart.addHistogramSeries({
      base: 0,
      priceFormat: { type: 'custom', formatter: v => (v*100).toFixed(4) + '%' },
      priceScaleId: 'right',
    });

    // Line series overlay for trend
    const lineSeries = _fundingChart.addLineSeries({
      color: 'rgba(187,134,252,0.7)',
      lineWidth: 1,
      priceFormat: { type: 'custom', formatter: v => (v*100).toFixed(4) + '%' },
      priceScaleId: 'right',
      crosshairMarkerVisible: false,
      lastValueVisible: false,
    });

    const sorted = data.sort((a,b) => a.time - b.time);
    const histData = sorted.map(d => ({
      time: Math.floor(d.time / 1000),
      value: parseFloat(d.fundingRate),
      color: parseFloat(d.fundingRate) >= 0 ? 'rgba(0,230,118,0.5)' : 'rgba(255,61,80,0.5)',
    }));
    const lineData = sorted.map(d => ({
      time: Math.floor(d.time / 1000),
      value: parseFloat(d.fundingRate),
    }));

    histSeries.setData(histData);
    lineSeries.setData(lineData);
    _fundingChart.timeScale().fitContent();

    // Meta stats
    const rates = sorted.map(d => parseFloat(d.fundingRate));
    const avg = rates.reduce((s,v)=>s+v,0) / rates.length;
    const max = Math.max(...rates), min = Math.min(...rates);
    const annualized = avg * 3 * 365 * 100; // 8h intervals * 3/day * 365
    set('mdFundingMeta', `Avg: ${(avg*100).toFixed(4)}% ¬∑ Ann: ${annualized.toFixed(1)}% ¬∑ ${data.length} datapoints`);

  } catch(e) {
    console.error('funding history', e);
    wrap.innerHTML = '<div class="es">Could not load funding history: '+e.message+'</div>';
  }
}

// L2 Order Book Depth ‚Äî uses l2Book endpoint
async function _loadL2Book(coin) {
  const wrap = $('mdOrderBook');
  if(!wrap) return;
  wrap.innerHTML = '<div class="es">Loading order book...</div>';

  try {
    const book = await hl({type:'l2Book', coin});
    const levels = Array.isArray(book?.levels) ? book.levels : (Array.isArray(book) ? book : null);
    if(!levels || levels.length < 2) {
      wrap.innerHTML = '<div class="es">No order book data for '+coin+'</div>';
      return;
    }

    const bids = (levels[0] || []).slice(0, 12);
    const asks = (levels[1] || []).slice(0, 12);

    const maxBidSz = Math.max(...bids.map(b => parseFloat(b.sz || 0)), 0.001);
    const maxAskSz = Math.max(...asks.map(a => parseFloat(a.sz || 0)), 0.001);

    const bestBid = parseFloat(bids[0]?.px || 0);
    const bestAsk = parseFloat(asks[0]?.px || 0);
    const spread = bestAsk - bestBid;
    const spreadPct = bestAsk > 0 ? (spread / bestAsk * 100) : 0;

    // Bid/ask imbalance
    const totalBidSz = bids.reduce((s,b) => s + parseFloat(b.sz || 0), 0);
    const totalAskSz = asks.reduce((s,a) => s + parseFloat(a.sz || 0), 0);
    const imbalance = totalBidSz + totalAskSz > 0 ? ((totalBidSz - totalAskSz) / (totalBidSz + totalAskSz) * 100) : 0;

    set('mdBookMeta', `Spread: $${spread < 0.01 ? spread.toFixed(6) : F.f2(spread)} (${spreadPct.toFixed(3)}%) ¬∑ Imbalance: ${imbalance > 0 ? '+' : ''}${imbalance.toFixed(1)}% ${imbalance > 10 ? 'üü¢ bid heavy' : imbalance < -10 ? 'üî¥ ask heavy' : '‚ö™ balanced'}`);

    let html = '<div class="ob-wrap">';

    // Bids (left)
    html += '<div class="ob-side ob-bids">';
    html += '<div class="ob-hdr"><span>Price (Bid)</span><span>Size</span></div>';
    bids.forEach(b => {
      const px = parseFloat(b.px || 0), sz = parseFloat(b.sz || 0);
      const pct = (sz / maxBidSz * 100).toFixed(0);
      html += `<div class="ob-row"><div class="ob-bg" style="width:${pct}%"></div><span class="ob-px">${px < 1 ? F.f4(px) : F.f2(px)}</span><span class="ob-sz">${F.c(sz)}</span></div>`;
    });
    html += '</div>';

    // Asks (right)
    html += '<div class="ob-side ob-asks">';
    html += '<div class="ob-hdr"><span>Price (Ask)</span><span>Size</span></div>';
    asks.forEach(a => {
      const px = parseFloat(a.px || 0), sz = parseFloat(a.sz || 0);
      const pct = (sz / maxAskSz * 100).toFixed(0);
      html += `<div class="ob-row"><div class="ob-bg" style="width:${pct}%"></div><span class="ob-px">${px < 1 ? F.f4(px) : F.f2(px)}</span><span class="ob-sz">${F.c(sz)}</span></div>`;
    });
    html += '</div>';

    html += '</div>';
    html += `<div class="ob-spread">Spread: $${spread < 0.01 ? spread.toFixed(6) : F.f2(spread)} (${spreadPct.toFixed(3)}%) ¬∑ Total Bid: ${F.c(totalBidSz)} ¬∑ Total Ask: ${F.c(totalAskSz)}</div>`;

    wrap.innerHTML = html;

  } catch(e) {
    console.error('l2book', e);
    wrap.innerHTML = '<div class="es">Could not load order book: '+e.message+'</div>';
  }
}

function closeMktDetail() {
  $('mktDetailPanel').style.display='none';
  if(_mktDetailChart){try{_mktDetailChart.remove();}catch(e){}_mktDetailChart=null;}
  if(_fundingChart){try{_fundingChart.remove();}catch(e){}_fundingChart=null;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW: WALLET INTELLIGENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _whaleWatch = JSON.parse(localStorage.getItem('hl_whalewatch') || '[]');
renderWhaleWatch();

function renderWhaleWatch() {
  const el = $('whaleWatchList');
  if(!el) return;
  el.innerHTML = _whaleWatch.map((addr,i) => `<div class="wallet-tag" onclick="document.getElementById('walletAddr').value='${addr}';lookupWallet()"><span>${F.addr(addr)}</span><span class="tag-x" onclick="event.stopPropagation();removeWatch(${i})">‚úï</span></div>`).join('');
}
function saveWatchAddr() {
  const addr = $('walletAddr').value.trim();
  if(!addr || !addr.startsWith('0x')) return;
  if(!_whaleWatch.includes(addr)) { _whaleWatch.push(addr); localStorage.setItem('hl_whalewatch', JSON.stringify(_whaleWatch)); renderWhaleWatch(); }
}
function removeWatch(i) { _whaleWatch.splice(i,1); localStorage.setItem('hl_whalewatch', JSON.stringify(_whaleWatch)); renderWhaleWatch(); }

// Wallet tab switching
function switchWalletTab(el, tpId) {
  el.parentElement.querySelectorAll('.wtab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.wtp').forEach(p => p.classList.remove('active'));
  const tp = $(tpId);
  if(tp) tp.classList.add('active');
}

async function lookupWallet() {
  const addr = $('walletAddr').value.trim();
  if(!addr || !addr.startsWith('0x')) { alert('Enter a valid 0x address'); return; }

  const btn = $('walletLookupBtn');
  btn.textContent = '‚è≥ LOADING...'; btn.classList.add('busy');
  $('walletResults').style.display = 'none';

  // Generate impersonation link
  const impLink = $('walletImpLink');
  impLink.href = `https://app.hyperliquid.xyz/trade/HYPE/USDC?hloa=${addr}`;
  impLink.style.display = 'inline-flex';

  try {
    // Fetch perp clearinghouse state + fills + funding
    const [perpState, spotState, orders, fills, funding] = await Promise.allSettled([
      hl({type:'clearinghouseState', user: addr}),
      hl({type:'spotClearinghouseState', user: addr}),
      hl({type:'openOrders', user: addr}),
      hl({type:'userFills', user: addr}),
      hl({type:'userFunding', user: addr, startTime: Date.now() - 7*86400000}),
    ]);

    const perp = perpState.status === 'fulfilled' ? perpState.value : null;
    const spot = spotState.status === 'fulfilled' ? spotState.value : null;
    const ords = orders.status === 'fulfilled' ? orders.value : [];
    const userFills = fills.status === 'fulfilled' ? fills.value : [];
    const userFunding = funding.status === 'fulfilled' ? funding.value : [];

    $('walletResults').style.display = 'block';

    // Account summary
    if(perp) {
      const mv = parseFloat(perp.marginSummary?.accountValue || perp.accountValue || 0);
      const pnl = parseFloat(perp.marginSummary?.totalNtlPos || 0);
      const mu = parseFloat(perp.marginSummary?.totalMarginUsed || 0);
      const positions = perp.assetPositions || [];
      const openPos = positions.filter(p => {
        const pos = p.position || p;
        return parseFloat(pos.szi || pos.size || 0) !== 0;
      });

      set('wAccVal', F.usd(mv));
      set('wAccValS', 'Margin account equity');

      // PnL
      let totalUpnl = 0;
      openPos.forEach(p => { const pos = p.position || p; totalUpnl += parseFloat(pos.unrealizedPnl || 0); });
      set('wPnl', (totalUpnl>=0?'+':'') + '$' + F.f2(Math.abs(totalUpnl)));
      const pnlEl = $('wPnl');
      if(pnlEl) pnlEl.style.color = totalUpnl >= 0 ? 'var(--green)' : 'var(--red)';
      set('wPnlS', openPos.length + ' open positions');

      set('wMargin', F.usd(mu));
      set('wMarginS', mv > 0 ? (mu/mv*100).toFixed(1) + '% utilized' : '‚Äî');
      set('wPosCount', openPos.length);

      // Positions list
      if(openPos.length) {
        htm('wPositions', openPos.map(p => {
          const pos = p.position || p;
          const coin = pos.coin || p.coin || '?';
          const sz = parseFloat(pos.szi || pos.size || 0);
          const side = sz > 0 ? 'LONG' : 'SHORT';
          const entry = parseFloat(pos.entryPx || 0);
          const mark = parseFloat(pos.markPx || pos.lastPrice || D.allMids[coin] || 0);
          const upnl = parseFloat(pos.unrealizedPnl || 0);
          const lev = parseFloat(pos.leverage?.value || pos.leverage || 0);
          const notional = Math.abs(sz) * mark;
          return `<div class="pos-row">
            <div><div class="pos-coin">${coin}</div><div class="pos-side ${sz>0?'pos-long':'pos-short'}">${side} ${lev?lev+'x':''}</div></div>
            <div style="font-size:11px"><div style="color:var(--text-dim);font-size:8px">SIZE</div>${F.c(Math.abs(sz))}</div>
            <div class="pos-val"><div style="color:var(--text-dim);font-size:8px">ENTRY</div>$${F.f2(entry)}</div>
            <div class="pos-val"><div style="color:var(--text-dim);font-size:8px">MARK</div>$${mark<1?F.f4(mark):F.f2(mark)}</div>
            <div class="pos-val"><div style="color:var(--text-dim);font-size:8px">UPNL</div><span style="color:${upnl>=0?'var(--green)':'var(--red)'}">${upnl>=0?'+':''}$${F.f2(Math.abs(upnl))}</span></div>
          </div>`;
        }).join(''));
        set('wPosMeta', openPos.length + ' positions ¬∑ ' + F.usd(openPos.reduce((s,p)=>{const pos=p.position||p;return s+Math.abs(parseFloat(pos.szi||0))*parseFloat(pos.markPx||0);},0)) + ' notional');
      } else {
        htm('wPositions', '<div class="es">No open perpetual positions</div>');
      }
    }

    // Spot holdings
    if(spot?.balances?.length) {
      const bals = spot.balances.filter(b => parseFloat(b.total || b.hold || 0) > 0);
      htm('wSpotHoldings', bals.length ? bals.map(b => {
        const coin = b.coin;
        const total = parseFloat(b.total || b.hold || 0);
        const mid = parseFloat(D.allMids[coin] || D.allMids['@107'] || 0);
        return `<div style="display:flex;justify-content:space-between;padding:6px 13px;border-bottom:1px solid rgba(26,36,48,.5);font-size:11px"><span style="color:var(--text-bright);font-weight:500">${coin}</span><span style="font-variant-numeric:tabular-nums">${F.c(total)}${mid?' ¬∑ '+F.usd(total*mid):''}</span></div>`;
      }).join('') : '<div class="es">No spot holdings</div>');
    }

    // Open orders
    if(Array.isArray(ords) && ords.length) {
      htm('wOpenOrders', ords.slice(0,20).map(o => {
        const side = o.side === 'B' ? 'BUY' : 'SELL';
        const sideClr = o.side === 'B' ? 'var(--green)' : 'var(--red)';
        return `<div style="display:flex;justify-content:space-between;padding:5px 13px;border-bottom:1px solid rgba(26,36,48,.5);font-size:10px"><span style="color:${sideClr};font-weight:700;width:40px">${side}</span><span style="color:var(--text-bright)">${o.coin||'?'}</span><span>${F.c(o.sz||0)}</span><span>@ $${F.f2(o.limitPx||0)}</span><span style="color:var(--text-dim)">${o.orderType||''}</span></div>`;
      }).join(''));
      set('wOrdersMeta', ords.length + ' resting orders');
    } else {
      htm('wOpenOrders', '<div class="es">No open orders</div>');
    }

    // ‚îÄ‚îÄ Recent Trade Fills ‚îÄ‚îÄ
    if(Array.isArray(userFills) && userFills.length) {
      const sorted = userFills.sort((a,b) => (b.time || 0) - (a.time || 0)).slice(0, 50);
      let totalVol = 0, totalFee = 0, wins = 0, losses = 0;
      sorted.forEach(f => {
        const notional = parseFloat(f.px || 0) * parseFloat(f.sz || 0);
        totalVol += notional;
        totalFee += parseFloat(f.fee || 0);
        const cpnl = parseFloat(f.closedPnl || 0);
        if(cpnl > 0) wins++;
        else if(cpnl < 0) losses++;
      });

      let fhtml = `<div style="padding:6px 13px;font-size:9px;color:var(--text-dim);background:var(--surface2);border-bottom:1px solid var(--border)">Last ${sorted.length} fills ¬∑ Vol: ${F.usd(totalVol)} ¬∑ Fees: $${F.f2(totalFee)} ¬∑ W/L: <span style="color:var(--green)">${wins}W</span>/<span style="color:var(--red)">${losses}L</span></div>`;
      fhtml += '<div class="fill-row fhdr"><div>Time</div><div>Market</div><div>Side</div><div style="text-align:right">Price</div><div style="text-align:right">Size</div><div style="text-align:right">Closed PnL</div></div>';
      fhtml += sorted.map(f => {
        const side = f.side === 'B' ? 'BUY' : 'SELL';
        const sideClr = f.side === 'B' ? 'var(--green)' : 'var(--red)';
        const cpnl = parseFloat(f.closedPnl || 0);
        const pnlClr = cpnl > 0 ? 'var(--green)' : cpnl < 0 ? 'var(--red)' : 'var(--text-dim)';
        const dt = new Date(f.time);
        const ts = dt.toLocaleDateString('en-US',{month:'short',day:'numeric'}) + ' ' + dt.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
        return `<div class="fill-row"><div style="color:var(--text-dim)">${ts}</div><div style="color:var(--text-bright);font-weight:500">${f.coin||'?'}</div><div style="color:${sideClr};font-weight:600">${side}</div><div style="text-align:right">$${parseFloat(f.px)<1?F.f4(f.px):F.f2(f.px)}</div><div style="text-align:right">${F.c(f.sz)}</div><div style="text-align:right;color:${pnlClr}">${cpnl!==0?(cpnl>0?'+':'')+('$'+F.f2(Math.abs(cpnl))):'‚Äî'}</div></div>`;
      }).join('');
      htm('wFillsList', '<div style="max-height:280px;overflow-y:auto">' + fhtml + '</div>');
    } else {
      htm('wFillsList', '<div class="es">No recent trade fills found</div>');
    }

    // ‚îÄ‚îÄ Funding Payments ‚îÄ‚îÄ
    if(Array.isArray(userFunding) && userFunding.length) {
      const sorted = userFunding.sort((a,b) => (b.time || 0) - (a.time || 0)).slice(0, 50);
      let totalPaid = 0, totalReceived = 0;
      sorted.forEach(f => {
        const amt = parseFloat(f.usdc || f.payment || 0);
        if(amt > 0) totalReceived += amt; else totalPaid += Math.abs(amt);
      });

      let fuhtml = `<div style="padding:6px 13px;font-size:9px;color:var(--text-dim);background:var(--surface2);border-bottom:1px solid var(--border)">7d funding: Received <span style="color:var(--green)">+$${F.f2(totalReceived)}</span> ¬∑ Paid <span style="color:var(--red)">-$${F.f2(totalPaid)}</span> ¬∑ Net: <span style="color:${totalReceived-totalPaid>=0?'var(--green)':'var(--red)'}">${totalReceived-totalPaid>=0?'+':''}$${F.f2(Math.abs(totalReceived-totalPaid))}</span></div>`;
      fuhtml += '<div class="fund-row fhdr"><div>Time</div><div>Market</div><div style="text-align:right">Rate</div><div style="text-align:right">Payment</div></div>';
      fuhtml += sorted.map(f => {
        const amt = parseFloat(f.usdc || f.payment || 0);
        const rate = parseFloat(f.fundingRate || 0);
        const clr = amt >= 0 ? 'var(--green)' : 'var(--red)';
        const dt = new Date(f.time);
        const ts = dt.toLocaleDateString('en-US',{month:'short',day:'numeric'}) + ' ' + dt.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
        return `<div class="fund-row"><div style="color:var(--text-dim)">${ts}</div><div style="color:var(--text-bright);font-weight:500">${f.coin||'?'}</div><div style="text-align:right">${(rate*100).toFixed(4)}%</div><div style="text-align:right;color:${clr}">${amt>=0?'+':''}$${F.f2(Math.abs(amt))}</div></div>`;
      }).join('');
      htm('wFundingList', '<div style="max-height:280px;overflow-y:auto">' + fuhtml + '</div>');
    } else {
      htm('wFundingList', '<div class="es">No funding payments in last 7 days</div>');
    }

  } catch(e) {
    console.error('wallet lookup', e);
    $('walletResults').style.display = 'block';
    htm('wPositions', `<div class="es">Error fetching data: ${e.message}</div>`);
  }

  btn.textContent = 'üîç LOOKUP'; btn.classList.remove('busy');
}

// Enter key on wallet input
$('walletAddr')?.addEventListener('keydown', e => { if(e.key === 'Enter') lookupWallet(); });


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIGHTWEIGHT CHARTS ‚Äî AF LIVE + PRICE + BURN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function _lcBase(extra) {
  return Object.assign({
    layout: { background: { color: '#060a0e' }, textColor: '#4a6678', fontFamily: "'IBM Plex Mono', monospace", fontSize: 10, },
    grid: { vertLines: { color: 'rgba(26,36,48,0.65)' }, horzLines: { color: 'rgba(26,36,48,0.65)' }, },
    crosshair: {
      mode: LightweightCharts.CrosshairMode.Normal,
      vertLine: { color: 'rgba(0,212,255,0.4)', labelBackgroundColor: '#0c1219', width: 1 },
      horzLine: { color: 'rgba(0,212,255,0.4)', labelBackgroundColor: '#0c1219', width: 1 },
    },
    rightPriceScale: { borderColor: '#1a2430', textColor: '#4a6678' },
    timeScale: { borderColor: '#1a2430', textColor: '#4a6678', timeVisible: true, secondsVisible: true },
    handleScroll: true, handleScale: true, autoSize: false,
  }, extra || {});
}

function _wrapSize(id) {
  const el = document.getElementById(id);
  return el ? { w: Math.max(el.clientWidth, 200), h: el.clientHeight || 280 } : { w: 800, h: 280 };
}

// ‚îÄ‚îÄ‚îÄ AF LIVE MONITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _afChart=null, _afPriceSeries=null, _afBidSeries=null, _afUsdcSeries=null, _afLiveTimer=null, _afSessionStart=Date.now(), _afFeesAtStart=null, _afPoints=[];

function _initAfChart() {
  const wrap=$('afWrap'); if(!wrap)return;
  if(_afChart){try{_afChart.remove();}catch(e){}_afChart=null;}
  wrap.innerHTML='';
  const{w,h}=_wrapSize('afWrap');
  _afChart=LightweightCharts.createChart(wrap,_lcBase({width:w,height:h,rightPriceScale:{borderColor:'#1a2430',textColor:'#4a6678',scaleMargins:{top:0.05,bottom:0.05}},leftPriceScale:{visible:false},timeScale:{borderColor:'#1a2430',textColor:'#4a6678',timeVisible:true,secondsVisible:true,rightOffset:4}}));
  _afPriceSeries=_afChart.addLineSeries({color:'#00d4ff',lineWidth:2,priceLineVisible:false,lastValueVisible:true,title:'HYPE',crosshairMarkerVisible:true,crosshairMarkerRadius:4,crosshairMarkerBackgroundColor:'#00d4ff'});
  _afBidSeries=_afChart.addLineSeries({color:'#ff3d50',lineWidth:1,lineStyle:LightweightCharts.LineStyle.Dashed,priceLineVisible:false,lastValueVisible:true,title:'AF Bid',crosshairMarkerVisible:true,crosshairMarkerRadius:3,crosshairMarkerBackgroundColor:'#ff3d50'});
  _afUsdcSeries=_afChart.addLineSeries({color:'#ff9a3c',lineWidth:1.5,priceScaleId:'usdc',priceLineVisible:false,lastValueVisible:true,title:'USDC',crosshairMarkerVisible:true,crosshairMarkerRadius:3,crosshairMarkerBackgroundColor:'#ff9a3c'});
  _afChart.priceScale('usdc').applyOptions({scaleMargins:{top:0.7,bottom:0},visible:true,borderColor:'#1a2430',textColor:'#4a6678'});
  _afChart.subscribeCrosshairMove(param=>{
    if(!param.time)return;
    const px=param.seriesData.get(_afPriceSeries),bid=param.seriesData.get(_afBidSeries),usd=param.seriesData.get(_afUsdcSeries);
    if(px)set('afLivePrice','$'+F.f2(px.value));
    if(bid)set('afLiveBid','$'+F.f2(bid.value));
    if(usd)set('afLiveUsdc',F.c(usd.value)+' USDC');
    if(px&&bid){const spread=((px.value-bid.value)/px.value*100).toFixed(3);const el=$('afLiveSpread');if(el){el.textContent=spread+'%';el.style.color=parseFloat(spread)<0.5?'var(--green)':'var(--yellow)';}}
  });
  _redrawAfSeries();
}

function _redrawAfSeries() {
  if(!_afChart||!_afPoints.length)return;
  try{
    const dedup=(arr)=>{const seen=new Set(),out=[];for(const p of arr){if(!seen.has(p.time)){seen.add(p.time);out.push(p);}}return out;};
    _afPriceSeries.setData(dedup(_afPoints.filter(p=>p.price!=null).map(p=>({time:p.time,value:p.price}))));
    _afBidSeries.setData(dedup(_afPoints.filter(p=>p.bid!=null).map(p=>({time:p.time,value:p.bid}))));
    _afUsdcSeries.setData(dedup(_afPoints.filter(p=>p.usdc!=null).map(p=>({time:p.time,value:p.usdc}))));
    _afChart.timeScale().fitContent();
  }catch(e){console.warn('af draw',e);}
}

async function _afLiveTick() {
  try{
    const mids=await hl({type:'allMids'}); const px=parseFloat(mids['@107']||mids['HYPE']||0);
    let usdc=null;
    try{const st=await hl({type:'spotClearinghouseState',user:AF});if(st?.balances){const u=st.balances.find(b=>b.coin==='USDC');if(u)usdc=parseFloat(u.total||u.hold||0);}}catch(e){}
    let bid=null,bidSz=null;
    try{const orders=await hl({type:'openOrders',user:AF});if(Array.isArray(orders)&&orders.length){const buyOrders=orders.filter(o=>o.side==='B').sort((a,b)=>parseFloat(b.limitPx||0)-parseFloat(a.limitPx||0));if(buyOrders[0]){bid=parseFloat(buyOrders[0].limitPx||buyOrders[0].px||0);bidSz=parseFloat(buyOrders[0].sz||0);}}}catch(e){}
    const t=Math.floor(Date.now()/1000);
    _afPoints.push({time:t,price:px||null,bid:bid||null,usdc:usdc||null});
    if(_afPoints.length>1440)_afPoints=_afPoints.slice(-1440);
    if(px){D.price=px;set('afLivePrice','$'+F.f2(px));set('topPrice','$'+F.f2(px));}
    if(bid)set('afLiveBid','$'+F.f2(bid));
    if(bidSz)set('afLiveSz',F.c(bidSz)+' HYPE ($'+F.f2(bidSz*(bid||px||1))+')');
    if(usdc!=null)set('afLiveUsdc',F.c(usdc)+' USDC');
    if(px&&bid){const spread=((px-bid)/px*100).toFixed(3);const el=$('afLiveSpread');if(el){el.textContent=spread+'%';el.style.color=parseFloat(spread)<0.5?'var(--green)':'var(--yellow)';}}
    if(D.fees24!=null){if(_afFeesAtStart==null)_afFeesAtStart=D.fees24;set('afLiveFees','$'+F.f2(Math.max(0,D.fees24-_afFeesAtStart)));}
    set('afChartMeta','Live ¬∑ Updated '+new Date().toLocaleTimeString()+' ¬∑ '+_afPoints.length+' pts');
    _redrawAfSeries();
  }catch(e){console.warn('af tick',e);}
}
function _startAfLive(){if(_afLiveTimer)clearInterval(_afLiveTimer);_afLiveTick();_afLiveTimer=setInterval(_afLiveTick,5000);}
function _stopAfLive(){if(_afLiveTimer){clearInterval(_afLiveTimer);_afLiveTimer=null;}}

// ‚îÄ‚îÄ‚îÄ PRICE CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _priceChart=null,_priceCandleSeries=null,_priceAreaSeries=null,_priceVolSeries=null,_priceCandleData=[],_priceTf=60,_priceType='candle';

function _initPriceChart() {
  const wrap=$('priceWrap'); if(!wrap)return;
  if(_priceChart){try{_priceChart.remove();}catch(e){}_priceChart=null;}
  _priceCandleSeries=null;_priceAreaSeries=null;_priceVolSeries=null;
  wrap.innerHTML='';
  const{w,h}=_wrapSize('priceWrap');
  _priceChart=LightweightCharts.createChart(wrap,_lcBase({width:w,height:h}));
  if(_priceType==='area'){
    _priceAreaSeries=_priceChart.addAreaSeries({lineColor:'#00d4ff',topColor:'rgba(0,212,255,0.2)',bottomColor:'rgba(0,212,255,0.01)',lineWidth:2,priceLineVisible:true,priceLineColor:'rgba(0,212,255,0.3)',crosshairMarkerVisible:true,crosshairMarkerRadius:4});
  }else{
    _priceCandleSeries=_priceChart.addCandlestickSeries({upColor:'#00e676',downColor:'#ff3d50',borderUpColor:'#00e676',borderDownColor:'#ff3d50',wickUpColor:'rgba(0,230,118,0.7)',wickDownColor:'rgba(255,61,80,0.7)',priceLineVisible:true,priceLineColor:'rgba(0,212,255,0.3)'});
  }
  _priceVolSeries=_priceChart.addHistogramSeries({color:'rgba(0,212,255,0.1)',priceFormat:{type:'volume'},priceScaleId:'vol',lastValueVisible:false,priceLineVisible:false});
  _priceChart.priceScale('vol').applyOptions({scaleMargins:{top:0.85,bottom:0},visible:false});
  const activeSeries=()=>_priceType==='area'?_priceAreaSeries:_priceCandleSeries;
  _priceChart.subscribeCrosshairMove(param=>{
    const s=activeSeries();if(!s||!param.time)return;
    const d=param.seriesData.get(s);if(!d)return;
    if(_priceType==='candle'){const chg=d.close-d.open,pct=(chg/d.open*100).toFixed(2);set('csO','$'+F.f2(d.open));set('csH','$'+F.f2(d.high));set('csL','$'+F.f2(d.low));set('csC','$'+F.f2(d.close));const el=$('csChg');if(el){el.textContent=(chg>=0?'+':'')+F.f2(chg)+' ('+pct+'%)';el.style.color=chg>=0?'var(--green)':'var(--red)';}}else{set('csC','$'+F.f2(d.value||0));}
    const vd=param.seriesData.get(_priceVolSeries);if(vd)set('csVol',F.c(vd.value));
  });
  if(_priceCandleData.length)_drawPriceSeries();
}

function _drawPriceSeries() {
  if(!_priceChart||!_priceCandleData.length)return;
  try{
    if(_priceType==='area'&&_priceAreaSeries){_priceAreaSeries.setData(_priceCandleData.map(c=>({time:c.time,value:c.close})));}
    else if(_priceCandleSeries){_priceCandleSeries.setData(_priceCandleData);}
    if(_priceVolSeries){_priceVolSeries.setData(_priceCandleData.map(c=>({time:c.time,value:c.volume,color:c.close>=c.open?'rgba(0,230,118,0.13)':'rgba(255,61,80,0.13)'})));}
    const last=_priceCandleData[_priceCandleData.length-1];
    if(last){const chg=last.close-last.open,pct=(chg/last.open*100).toFixed(2);set('csO','$'+F.f2(last.open));set('csH','$'+F.f2(last.high));set('csL','$'+F.f2(last.low));set('csC','$'+F.f2(last.close));const el=$('csChg');if(el){el.textContent=(chg>=0?'+':'')+F.f2(chg)+' ('+pct+'%)';el.style.color=chg>=0?'var(--green)':'var(--red)';}set('csVol',F.c(last.volume));}
    _priceChart.timeScale().fitContent();
  }catch(e){console.warn('price draw',e);}
}

async function _fetchCandles(tf) {
  const im={60:'1h',240:'4h',1440:'1D',10080:'1W'};
  const interval=im[tf]||'1h';
  const endTime=Date.now(),startTime=endTime-tf*60*1000*200;
  try{
    const d=await hl({type:'candleSnapshot',req:{coin:'@107',interval,startTime,endTime}});
    if(Array.isArray(d)&&d.length){
      _priceCandleData=d.map(c=>({time:Math.floor(c.t/1000),open:parseFloat(c.o),high:parseFloat(c.h),low:parseFloat(c.l),close:parseFloat(c.c),volume:parseFloat(c.v)})).sort((a,b)=>a.time-b.time);
      return true;
    }
  }catch(e){console.warn('candle fetch',e);}
  return false;
}

async function loadPriceChart(tf,btn) {
  _priceTf=tf;
  document.querySelectorAll('[data-ptf]').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  set('priceChartMeta','Loading candles‚Ä¶');
  const ok=await _fetchCandles(tf);
  if(ok){_drawPriceSeries();set('priceChartMeta',_priceCandleData.length+' candles ¬∑ HYPE @107');}
  else set('priceChartMeta','No data returned');
}

function setPriceType(type) {
  _priceType=type;
  $('btnCandle').classList.toggle('active',type==='candle');
  $('btnArea').classList.toggle('active',type==='area');
  _initPriceChart();
}

// ‚îÄ‚îÄ‚îÄ BURN CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _burnChart=null, _burnAreaSeries=null, _burnHours=24;

function _initBurnChart() {
  const wrap=$('burnWrap'); if(!wrap)return;
  if(_burnChart){try{_burnChart.remove();}catch(e){}_burnChart=null;_burnAreaSeries=null;}
  wrap.innerHTML='';
  const{w,h}=_wrapSize('burnWrap');
  _burnChart=LightweightCharts.createChart(wrap,_lcBase({width:w,height:h,rightPriceScale:{borderColor:'#1a2430',textColor:'#4a6678',scaleMargins:{top:0.1,bottom:0.05}}}));
  _burnAreaSeries=_burnChart.addAreaSeries({lineColor:'#ff5e1a',topColor:'rgba(255,94,26,0.25)',bottomColor:'rgba(255,94,26,0.01)',lineWidth:2,priceLineVisible:false,crosshairMarkerVisible:true,crosshairMarkerRadius:4,priceFormat:{type:'custom',formatter:v=>F.c(v)+' HYPE'}});
  _burnChart.subscribeCrosshairMove(param=>{
    if(!param.time||!_burnAreaSeries)return;
    const d=param.seriesData.get(_burnAreaSeries);
    if(d){set('bsPeriod',F.c(d.value)+' HYPE');if(D.price)set('bsUsd',F.usd(d.value*D.price));}
  });
  _drawBurnSeries();
}

function _drawBurnSeries() {
  if(!_burnAreaSeries)return;
  const sorted=[...D.feesRecent].sort((a,b)=>+(a.time||a.timestamp||0)-(+(b.time||b.timestamp||0)));
  if(!sorted.length)return;
  const cutoff=_burnHours>0?Date.now()-_burnHours*3600000:0;
  const filtered=sorted.filter(p=>+(p.time||p.timestamp||0)>cutoff);
  if(filtered.length<2)return;
  const px=D.price||1;
  let cum=0;
  const pts=[],seen=new Set();
  for(const p of filtered){
    cum+=parseFloat(p.total||p.fees||p.amount||0)/px;
    const t=Math.floor(+(p.time||p.timestamp||0)/1000);
    if(!seen.has(t)){seen.add(t);pts.push({time:t,value:cum});}
  }
  if(pts.length<2)return;
  try{
    _burnAreaSeries.setData(pts);
    set('bsTotal',F.c(D.burned||cum)+' HYPE');
    set('bsPeriod',F.c(cum)+' HYPE');
    if(D.price)set('bsUsd',F.usd(cum*D.price));
    const tspan=(+(filtered[filtered.length-1].time||filtered[filtered.length-1].timestamp||0)-+(filtered[0].time||filtered[0].timestamp||0))/3600000;
    if(tspan>0)set('bsRate',F.c(cum/tspan)+'/hr');
    _burnChart.timeScale().fitContent();
  }catch(e){console.warn('burn draw',e);}
}

function setBurnWindow(hours,btn) {
  _burnHours=hours;
  document.querySelectorAll('[data-btf]').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  _drawBurnSeries();
  if(_burnChart)_burnChart.timeScale().fitContent();
}

// ‚îÄ‚îÄ‚îÄ RESIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _resizeCharts() {
  if(_afChart){const{w,h}=_wrapSize('afWrap');_afChart.applyOptions({width:w,height:h});}
  if(_priceChart){const{w,h}=_wrapSize('priceWrap');_priceChart.applyOptions({width:w,height:h});}
  if(_burnChart){const{w,h}=_wrapSize('burnWrap');_burnChart.applyOptions({width:w,height:h});}
  if(_mktDetailChart){const wrap=$('mktDetailChartWrap');if(wrap){const w=Math.max(wrap.clientWidth,200);_mktDetailChart.applyOptions({width:w,height:220});}}
}
window.addEventListener('resize',_resizeCharts);

// ‚îÄ‚îÄ‚îÄ INIT CHARTS TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _chartsInited=false;
async function _initChartsTab() {
  if(_chartsInited){setTimeout(_resizeCharts,20);return;}
  _chartsInited=true;
  _initAfChart();
  _initPriceChart();
  _initBurnChart();
  _startAfLive();
  await loadPriceChart(_priceTf,document.querySelector('[data-ptf="60"]'));
  setTimeout(_resizeCharts,50);
}

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.tp').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    const p = $('tab-' + t.dataset.tab); if (p) p.classList.add('active');
    if (t.dataset.tab === 'charts') {
      setTimeout(_initChartsTab, 30);
    } else {
      _stopAfLive();
      if (t.dataset.tab === 'fees') setTimeout(()=>{drawFeeCanvasChart();}, 50);
      if (t.dataset.tab === 'staking') setTimeout(()=>{drawValDonut();}, 50);
      if (t.dataset.tab === 'unstaking') setTimeout(()=>{renderUnstakingHistogram();}, 50);
      if (t.dataset.tab === 'globalstats') setTimeout(()=>{renderGlobalStats();}, 50);
      if (t.dataset.tab === 'markets') setTimeout(()=>{renderMarketExplorer();}, 50);
    }
  });
});

// ‚îÄ‚îÄ‚îÄ AUTO REFRESH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setInterval(async () => {
  await Promise.allSettled([fPrice(), fSpot()]);
  if (D.price) {
    set('topPrice', '$' + F.f2(D.price));
    set('sbPrice', '$' + F.f2(D.price));
    set('tsUpdated', new Date().toLocaleTimeString());
  }
}, 15000);
setInterval(loadAll, 90000);

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadAll();
</script>
</body>
</html>
